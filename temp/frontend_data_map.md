# フロントエンドデータマップ

## 1. ログインページ (login-page.html)

### 表示データ
- アプリケーションタイトル/ロゴ
- ログインフォーム（メールアドレス、パスワード）
- エラーメッセージ（該当する場合）

### データフロー
1. ユーザーがメールアドレスとパスワードを入力
2. Firebase Authenticationでユーザー認証
3. 認証成功時：
   - ユーザー情報取得（`users` コレクション）
   - プロフィール完了状態チェック（`users.profileCompleted`）
   - 完了済み：ホーム（運勢ページ）へリダイレクト
   - 未完了：プロフィール設定ページへリダイレクト

### APIエンドポイント
- `POST /auth/login` - ユーザー認証
- `GET /users/me` - ログインユーザー情報取得

## 2. プロフィール設定ページ (profile-settings.html)

### 表示データ
- ユーザー基本情報（名前、メールなど）
- 出生情報（生年月日、出生時間、出生地）
- 個人目標リスト（キャリア、チーム、個人の3カテゴリ）
- 四柱推命情報（年柱、月柱、日柱、時柱の情報）
- 性格特性と適性情報
- セキュリティ設定（パスワード変更など）

### データフロー
1. ユーザープロフィール情報取得（`users` コレクション）
2. 個人目標リスト取得（`goals` コレクションから `userId` でフィルタ）
3. 出生情報が変更された場合：
   - SajuEngine経由で四柱推命情報を再計算
   - ユーザープロフィール更新
4. 目標が追加/編集/削除された場合：
   - `goals` コレクションを更新

### APIエンドポイント
- `GET /users/me` - ユーザープロフィール取得
- `PUT /users/me` - ユーザープロフィール更新
- `GET /goals` - ユーザーの目標リスト取得
- `POST /goals` - 新規目標追加
- `PUT /goals/:id` - 目標更新
- `DELETE /goals/:id` - 目標削除
- `POST /users/birth-data` - 出生データ更新と四柱推命情報計算

## 3. デイリー運勢ページ (daily-fortune.html)

### 表示データ
- 今日の運勢スコア（0-100点）
- 日柱情報と五行属性（例：「水の陽 (壬午)」）
- ラッキーアイテム情報（色、アイテム、ドリンクなど）
- 運勢の詳細説明（マークダウン形式）
- 個人目標へのアドバイス
- チーム目標へのアドバイス

### データフロー
1. 今日の日付でユーザーの運勢情報取得（`fortunes` コレクション）
2. データがない場合は生成APIを呼び出し
3. ユーザーの個人目標で、運勢と相性の良いものを取得（`goals` コレクション）
4. 所属チームの目標情報取得（`teams.goals`）

### APIエンドポイント
- `GET /fortunes/today` - 今日の運勢情報取得
- `POST /fortunes/generate` - 新規運勢情報生成（バックエンドでキャッシュ）
- `GET /goals/compatible` - 今日の運勢と相性の良い目標取得
- `GET /teams/my/goals` - 所属チームの目標情報取得

## 4. 統合AIチャットページ (integrated-chat.html)

### 表示データ
- チャットモード選択（個人運勢/チームメイト相性/チーム目標）
- チームメンバー選択（相性モード時）
- チャットメッセージ履歴
- コンテキスト情報（選択したモードに応じて異なる）

### データフロー
1. チャットセッション情報取得（`chat_sessions` コレクション）
2. チャットメッセージ履歴取得（`chat_messages` コレクション）
3. モードに応じたコンテキスト情報取得：
   - 個人運勢モード：今日の運勢情報（`fortunes`）
   - チームメイト相性モード：選択したメンバーとの相性情報（`compatibility`）
   - チーム目標モード：チーム目標情報（`teams.goals`）
4. メッセージ送信時：
   - 新規メッセージを `chat_messages` に保存
   - Claude AIへリクエスト送信（コンテキスト情報を含む）
   - AI応答を `chat_messages` に保存

### APIエンドポイント
- `GET /chat/sessions` - ユーザーのチャットセッション一覧取得
- `POST /chat/sessions` - 新規チャットセッション作成
- `GET /chat/sessions/:id/messages` - セッションのメッセージ履歴取得
- `POST /chat/sessions/:id/messages` - 新規メッセージ送信
- `GET /users/team-members` - チームメンバー一覧取得
- `GET /compatibility/:userId` - 特定ユーザーとの相性情報取得

## 5. チームページ (team-page.html)

### 表示データ
- チームメンバーリスト（名前、役割、五行属性）
- チーム全体の運勢ランキング
- メンバー間の相性スコア
- メンバー詳細情報（モーダル表示）
- 相性詳細とアドバイス

### データフロー
1. チーム情報とメンバーリスト取得（`teams` と `users` コレクション）
2. 各メンバーの今日の運勢スコア取得（`fortunes` コレクション）
3. ログインユーザーと各メンバー間の相性情報取得（`compatibility` コレクション）
4. メンバー詳細表示時：
   - 選択したメンバーとの詳細な相性情報取得

### APIエンドポイント
- `GET /teams/my` - 所属チーム情報取得
- `GET /users/team-members` - チームメンバー一覧取得
- `GET /fortunes/team/today` - チーム全体の今日の運勢取得
- `GET /compatibility/:userId` - 特定ユーザーとの相性情報取得
- `GET /compatibility/:userId/details` - 詳細な相性情報取得

## 6. 経営者ダッシュボード (team-management.html)

### 表示データ
- チーム概要統計（メンバー数、平均運勢スコアなど）
- チーム目標リスト（進捗状況含む）
- チームメンバーテーブル（詳細情報）
- モチベーション・離職リスクアラート
- メンバーインサイト（AI分析に基づく）

### データフロー
1. チーム情報と統計情報取得（`teams` コレクション）
2. チームメンバー一覧と詳細情報取得（`users` コレクション）
3. チャット分析に基づくインサイト情報取得
4. チーム目標管理：
   - 新規目標追加/既存目標編集時は `teams.goals` 更新

### APIエンドポイント
- `GET /teams/my/stats` - チーム統計情報取得
- `GET /users/team-members/details` - メンバー詳細情報取得
- `GET /insights/team` - チーム分析インサイト取得
- `GET /insights/members` - メンバー個別インサイト取得
- `PUT /teams/my/goals` - チーム目標更新
- `POST /teams/invite` - 新規メンバー招待コード生成

## 7. システム管理ページ (system-admin-page.html)

### 表示データ
- 管理者アカウント一覧
- システム設定（運勢更新時間、API制限など）
- 利用統計情報（ユーザー数、AI利用量など）
- システムログ
- メンテナンス機能

### データフロー
1. 管理者アカウント一覧取得（`users` コレクション、role=adminまたはsuperadmin）
2. システム設定情報取得（`system_settings` コレクション）
3. ログ情報取得（`logs` コレクション）
4. 複数コレクションからの集計情報取得（統計用）
5. メンテナンス操作実行（バックアップ、キャッシュクリアなど）

### APIエンドポイント
- `GET /admin/users` - 管理者ユーザー一覧取得
- `POST /admin/users` - 新規管理者追加
- `PUT /admin/users/:id` - 管理者情報更新
- `GET /admin/settings` - システム設定取得
- `PUT /admin/settings/:key` - システム設定更新
- `GET /admin/stats` - 利用統計情報取得
- `GET /admin/logs` - システムログ取得
- `POST /admin/maintenance/backup` - バックアップ実行
- `POST /admin/maintenance/cache/clear` - キャッシュクリア

## データ取得最適化

### バッチ取得パターン
特にホームページやチームページなど、複数のデータソースからデータを取得する必要があるページでは、バッチAPIを使用して一度のリクエストで複数の情報を取得します。

```
GET /batch
Body: {
  "requests": [
    { "path": "/fortunes/today" },
    { "path": "/users/team-members" },
    { "path": "/teams/my/goals" }
  ]
}
```

### リアルタイム更新
チャットやチーム情報など、リアルタイム性が求められる機能には、WebSocketまたはServer-Sent Eventsを使用してデータの即時反映を実現します。

### クライアントサイドキャッシュ
- 四柱推命の基本情報など、頻繁に変更されない情報はクライアントでキャッシュ
- 運勢情報は1日単位でキャッシュ（日付変更時に再取得）
- React QueryやSWRなどのデータフェッチライブラリを活用

### オフライン対応
PWA要件に対応し、基本的なデータをIndexedDBに保存することで、オフライン時も限定的な機能が利用可能なように設計します。
