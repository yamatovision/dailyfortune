# チームコンテキスト運勢リファクタリング

## 実装状況

### 2025/4/13 現在

- [x] モデル定義：TeamContextFortune
- [x] サービス実装：チームコンテキスト運勢生成機能
- [x] サービス実装：チーム運勢ランキング取得機能
- [x] コントローラー実装：エンドポイント追加
- [x] フロントエンド実装：チームコンテキスト運勢カード
- [x] フロントエンド実装：チーム運勢ランキング表示
- [x] フロントエンド実装：チーム選択ドロップダウン
- [x] バッチ処理：日次運勢更新時のチームコンテキスト運勢生成

## 残タスク

1. [x] サービスレベルのユニットテスト拡充
2. [x] バッチ処理のテスト
3. [ ] E2Eテスト拡充

## 実装詳細

### モデル定義

TeamContextFortuneモデルは、特定のユーザーがチーム内での運勢を表すものです。個人の運勢とは別に、チーム内での役割や目標に基づいた運勢スコア、アドバイス、協力のヒントなどを保持します。

```typescript
export interface ITeamContextFortune {
  userId: mongoose.Types.ObjectId | string;
  teamId: mongoose.Types.ObjectId | string;
  date: Date;
  dayPillarId: mongoose.Types.ObjectId;
  teamGoalId?: mongoose.Types.ObjectId;
  fortuneScore: number;
  teamContextAdvice: string;
  collaborationTips: string[];
  createdAt: Date;
  updatedAt: Date;
}
```

### 生成方法

チームコンテキスト運勢は以下の要素を考慮して生成されます：

1. ユーザーの四柱推命プロフィール
2. 当日の日柱エネルギー
3. チーム内での役割
4. チームの目標（設定されている場合）
5. チームメンバーとの相性

### バッチ処理との統合

- 日次運勢更新バッチ（`daily-fortune-update.ts`）内で、個人の運勢生成後にチームコンテキスト運勢も自動生成
- チームに所属するユーザーのみが対象
- エラー処理を実装済み（個人運勢生成の成功には影響しない）

### チーム運勢ランキング

- getTeamFortuneRanking メソッドを実装
- 指定された日付のチームメンバー全員の運勢スコアをランキング形式で取得
- チームコンテキスト運勢がある場合はそのスコアを優先的に使用
- 存在しない場合は個人運勢スコアを使用

### フロントエンド実装

- TeamContextFortuneCard コンポーネント
- TeamFortuneRanking コンポーネント
- TeamSelectorDropdown コンポーネント

## テスト状況

### コントローラーテスト

- fortune.controller.team-ranking.test.ts
  - [x] チーム運勢ランキング取得テスト
  - [x] 無効なチームIDテスト
  - [x] チームメンバーがいない場合のテスト

### サービステスト

- fortune.service.test.ts
  - [x] getTeamContextFortune メソッドのテスト
  - [x] generateTeamContextFortune メソッドのテスト
  - [x] getTeamFortuneRanking メソッドのテスト

### バッチ処理テスト

- batch-team-fortune-simple.test.ts
  - [x] チームに所属するユーザーの運勢更新時にチームコンテキスト運勢も生成されること
  - [x] forceUpdate=trueの場合はチームコンテキスト運勢も強制更新されること
  - [x] チームコンテキスト運勢生成中にエラーが発生しても個人運勢処理は成功とカウントされること
  - [x] ユーザーの所属チーム変更後に運勢更新を実行すると新しいチームの運勢が生成されること

- batch-team-fortune-generation.test.ts
  - [x] チームに所属するユーザーの運勢更新時にチームコンテキスト運勢も生成されること
  - [x] forceUpdate=trueの場合はチームコンテキスト運勢も強制更新されること
  - [x] チームコンテキスト運勢生成中にエラーが発生しても個人運勢処理は成功とカウントされること
  - [x] ユーザーの所属チームが変更された場合、新しいチームのチームコンテキスト運勢が生成されること
  - [x] 多数のユーザーがいる場合もバッチサイズに従って正しく処理されること

## 注意点

1. チームコンテキスト運勢はユーザーIDとチームIDの組み合わせで一意であること
2. 日付の正規化（時刻部分をリセット）を適切に行うこと
3. 既存の運勢更新バッチにエラーハンドリングを追加
4. チームメンバー変更時の整合性を考慮すること
5. テスト環境では様々なエラーが発生する可能性があるため、柔軟なテスト戦略が必要

## テスト実装メモ

バッチ処理テストの実装にあたって直面した課題と解決策については、以下のドキュメントにまとめました：

- [バッチ処理テスト実装メモ](/server/batch-test-memo.md)

テスト実行の結果、バッチ処理のテストは複雑であり、実環境でのエラー処理が重要であることが確認されました。特に以下の点に注意が必要です：

1. ユーザーの検索エラー処理
2. チームメンバーシップの適切な設定と検証
3. 日柱データの事前確保
4. テスト実行時のデータ整合性