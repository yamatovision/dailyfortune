# チームコンテキスト運勢データリファクタリング計画

## 概要

現在の運勢データシステムはユーザー単位となっており、チームコンテキストを十分に考慮していません。本リファクタリングでは、個人運勢とチームコンテキスト運勢を分離し、ユーザーが所属する各チームごとに特化した運勢アドバイスを提供できるようにします。

## 実装状況（2025/4/12更新）

### 実装済み
- TeamContextFortuneモデルの作成
- 型定義ファイルの更新（shared/index.ts、server/src/types/index.ts）
  - チームコンテキスト運勢の型定義
  - 運勢ダッシュボードレスポンスの型定義
  - 関連APIパスの定義
- FortuneService拡張：チームコンテキスト運勢の生成・取得メソッド
  - `getTeamContextFortune(userId, teamId)`
  - `generateTeamContextFortune(userId, teamId, date)`
  - `generateTeamContextAdvice(user, team, teamGoal, dayPillar, fortuneScore)`
  - `generateCollaborationTips(userElement, teamGoalContent, heavenlyStem, earthlyBranch)`
  - `getTeamFortuneRanking(teamId)` - チームメンバーの運勢スコアランキング取得
- FortuneController拡張：チームコンテキスト運勢の取得用APIエンドポイント
  - `GET /api/v1/fortune/team/:teamId/context`
  - `POST /api/v1/fortune/team/:teamId/context/generate`
  - `GET /api/v1/fortune/dashboard`（統合ダッシュボード）
  - `GET /api/v1/fortune/team/:teamId/ranking`（チーム運勢ランキング）
- `getFortuneDashboard(userId, teamId?)`：ユーザーの基本運勢とチームコンテキスト運勢を統合したデータを返す
- バッチ処理拡張：DailyFortuneUpdate処理のチームコンテキスト運勢対応
- クライアント側サービス拡張：チームコンテキスト運勢の取得
  - `getTeamContextFortune(teamId)`
  - `getFortuneDashboard(teamId?)`
  - `getTeamFortuneRanking(teamId)`
- 運勢ページ拡張（Fortune/index.tsx）：
  - チーム選択UIの追加
  - 個人/チーム切替タブの実装
  - チームコンテキストビューへのチームランキング表示統合
- 新規コンポーネント作成：
  - `components/fortune/TeamContextFortuneCard.tsx`
  - `components/fortune/TeamSelectorDropdown.tsx`
  - `components/fortune/TeamFortuneRanking.tsx`
- バックエンドテスト：
  - `tests/controllers/fortune.controller.team-ranking.test.ts`：チームコンテキスト・ダッシュボード・ランキングAPIのテスト

### 未実装（残タスク）
1. **フロントエンド実装の追加**
   - `components/fortune/TeamCollaborationTips.tsx`（現在は TeamContextFortuneCard 内に統合済み）

2. **残りのテスト**
   - `tests/services/fortune.service.test.ts`：チームコンテキスト運勢生成機能のテスト拡充
   - バッチ処理のテスト：チームコンテキスト運勢の自動生成が正しく行われるか検証

### 今回実装内容（2025/4/12追加）
1. **FortuneService拡張**
   - `getTeamFortuneRanking(teamId)` メソッド実装
   - チームに所属するメンバーの運勢スコアをランキング形式で取得
   - 運勢スコアの降順でソートと順位付け機能

2. **テスト改善**
   - `tests/controllers/fortune.controller.team-ranking.test.ts` のモックテストを実データテストに書き換え
   - MongoDB接続管理のためのユーティリティクラス `MongoDBConnector` 追加
   - 実際の環境データを使った堅牢なテスト実装

## 解決した課題

- 運勢データにチーム目標を反映：Claude AIを用いたプロンプトに直接チーム目標情報を組み込み
- 管理者が複数チームを管理する場合のコンテキスト切替：ドロップダウンUIで実装
- ユーザーは所属チームに応じた運勢情報を参照可能に：チーム選択と切替UI実装
- チーム運勢表示に特化したUIコンポーネント：TeamContextFortuneCardを実装
- 運勢データの重複問題解消：常時上書き方式への変更

## 達成した目標

1. ユーザーの基本運勢とチームコンテキスト運勢の分離：別モデルとして実装
2. チーム目標を運勢データ生成に組み込み：Claude AIプロンプトに具体的なチーム目標を参照
3. チーム切替に対応した運勢表示UIの実装：タブとドロップダウンの組み合わせ
4. 統合ダッシュボードAPIによるパフォーマンス最適化：単一リクエストで必要な情報を取得

## 実装アプローチ

### 1. データモデルの拡張

#### 新規モデル: `TeamContextFortune`

```typescript
// TeamContextFortune.ts
export interface ITeamContextFortune {
  userId: mongoose.Types.ObjectId | string;
  teamId: mongoose.Types.ObjectId;
  date: Date;
  dayPillarId: mongoose.Types.ObjectId;
  teamGoalId?: mongoose.Types.ObjectId;
  fortuneScore: number;
  teamContextAdvice: string;
  collaborationTips: string[];
  createdAt: Date;
  updatedAt: Date;
}

const teamContextFortuneSchema = new Schema<ITeamContextFortuneDocument>({
  // フィールド定義
});

// ユニーク制約 - 同じユーザーの同じチーム・同じ日付での重複を防止
teamContextFortuneSchema.index({ userId: 1, teamId: 1, date: 1 }, { unique: true });
```

### 2. バックエンドAPI拡張

#### shared/index.ts への追加

```typescript
// 運勢関連APIパス定義拡張
export const FORTUNE = {
  // 既存のAPIパス
  GET_DAILY_FORTUNE: `${API_BASE_PATH}/fortune/daily`,
  REFRESH_DAILY_FORTUNE: `${API_BASE_PATH}/fortune/daily/refresh`,
  GENERATE_FORTUNE: `${API_BASE_PATH}/fortune/generate`,
  
  // チームコンテキスト運勢API追加
  GET_TEAM_CONTEXT_FORTUNE: (teamId: string) => 
    `${API_BASE_PATH}/fortune/team/${teamId}/context`,
  
  // 統合ダッシュボードAPI追加
  GET_FORTUNE_DASHBOARD: (teamId?: string) => 
    teamId ? `${API_BASE_PATH}/fortune/dashboard?teamId=${teamId}` 
           : `${API_BASE_PATH}/fortune/dashboard`,
};
```

#### コントローラー・サービス実装

1. `fortune.controller.ts` にエンドポイント追加
2. `fortune.service.ts` にチームコンテキスト運勢生成機能追加
3. `daily-fortune-update.ts` バッチ処理拡張

### 3. フロントエンド実装

#### 運勢サービス拡張 (`fortune.service.ts`)

```typescript
// チームコンテキスト運勢取得
async getTeamContextFortune(teamId: string): Promise<ITeamContextFortune> {
  try {
    const response = await apiService.get(FORTUNE.GET_TEAM_CONTEXT_FORTUNE(teamId));
    return response.data;
  } catch (error) {
    console.error(`チームコンテキスト運勢の取得に失敗しました`, error);
    throw error;
  }
}

// 統合ダッシュボード取得
async getFortuneDashboard(teamId?: string): Promise<any> {
  try {
    const response = await apiService.get(FORTUNE.GET_FORTUNE_DASHBOARD(teamId));
    return response.data;
  } catch (error) {
    console.error('運勢ダッシュボードの取得に失敗しました', error);
    throw error;
  }
}
```

#### 運勢ページの拡張 (`Fortune/index.tsx`)

1. チーム選択UIの追加
2. 個人/チーム切替タブの実装
3. チームコンテキスト表示コンポーネントの作成

#### 新規コンポーネント作成

1. `TeamContextFortuneCard.tsx` - チーム特化運勢表示
2. `TeamCollaborationTips.tsx` - チーム協力のヒント表示
3. `TeamSelectorDropdown.tsx` - チーム選択ドロップダウン

### 4. バッチ処理の拡張

- `daily-fortune-update.ts` を拡張し、チームコンテキスト運勢の一括生成ロジック追加
- 個人運勢生成後に、各ユーザーの所属チームごとにチームコンテキスト運勢を生成

### 5. Claude APIプロンプト拡張

```typescript
// チームコンテキスト考慮のプロンプト生成
async function generateTeamContextPrompt(user, team, teamGoal, dayPillar, fortuneScore) {
  let prompt = `あなたは四柱推命に基づいてチーム運勢アドバイスを作成する専門家です。
以下の情報に基づいて、チームコンテキストに特化した運勢アドバイスを作成してください。

## ユーザー情報
- ユーザー名: ${user.displayName}
- 役職/役割: ${user.teamRole || user.jobTitle || "一般社員"}
- 五行属性: ${user.elementAttribute || "不明"}

## チーム情報
- チーム名: ${team.name}
- チーム目標: ${teamGoal?.content || "目標未設定"}
- 目標期限: ${teamGoal?.deadline ? new Date(teamGoal.deadline).toLocaleDateString() : "期限未設定"}
- チーム進捗率: ${teamGoal?.progressRate || 0}%

## 日柱情報
- 天干: ${dayPillar.heavenlyStem}
- 地支: ${dayPillar.earthlyBranch}
- 運勢スコア: ${fortuneScore}/100

## 出力形式
- チームにおける今日の運勢: 150-200文字の具体的なアドバイス
- チーム目標達成のためのヒント: 3つの短いポイント
- チームメンバーとの協力のポイント: 2-3つの実践的なアドバイス

特に以下の点に注意してください：
1. チーム目標を具体的に参照したアドバイス
2. ユーザーの役割に応じた視点からのアドバイス
3. 日柱の五行特性とチーム全体の相性を考慮
`;

  return prompt;
}
```

## 実装ステップと進捗状況

### フェーズ1: データモデルと基本APIの構築

1. ✅ `TeamContextFortune` モデルの作成
2. ✅ 基本的な取得・更新APIエンドポイントの実装
   - `GET /api/v1/fortune/team/:teamId/context`
   - `POST /api/v1/fortune/team/:teamId/context/generate`
3. ✅ チームコンテキスト運勢生成ロジックの実装
   - `generateTeamContextFortune(userId, teamId, date)`
   - `generateTeamContextAdvice(user, team, teamGoal, dayPillar, fortuneScore)`
4. ✅ テスト用スクリプトの作成
   - `tests/controllers/fortune.controller.team-ranking.test.ts`

### フェーズ2: バッチ処理の拡張

1. ✅ `daily-fortune-update.ts` の拡張
2. ✅ 個人運勢からチームコンテキスト運勢への派生ロジック実装
3. ✅ チーム目標変更時の運勢更新トリガー実装
4. 🔄 バッチ処理のテスト（一部実装済み）

### フェーズ3: フロントエンドの実装

1. ✅ `fortune.service.ts` の拡張（クライアント側）
2. ✅ チーム選択UIとタブ切替の実装
3. ✅ チームコンテキスト表示コンポーネントの作成
   - `TeamContextFortuneCard`
   - `TeamFortuneRanking` 
4. ✅ 個人/チーム運勢切替ロジックの実装

### フェーズ4: テストと最適化

1. ✅ 各機能の統合テスト
   - コントローラーテスト実装済み
   - チームランキングAPIのテスト実装
   - 実データを使用したテストに変更
2. ✅ API効率化のための最適化
   - 統合ダッシュボードAPIの実装 (`GET /api/v1/fortune/dashboard`)
   - チームランキングAPIの実装 (`GET /api/v1/fortune/team/:teamId/ranking`)
3. ✅ パフォーマンス測定
   - 運勢データ取得の最適化済み
   - 複数チームデータ取得の効率化
4. ✅ エッジケースの処理
   - チームメンバーシップ変更時の対応
   - データ不整合時の復旧処理
   - チームデータが存在しない場合の適切なエラーハンドリング

✅: 完了 | 🔄: 部分的に実装済み | ❌: 未実装

## 影響範囲の詳細調査

### 修正が必要なファイル

1. **データモデル関連:**
   - `server/src/models/DailyFortune.ts` - 運勢データ構造の修正
   - `server/src/models/Team.ts` - チーム目標と運勢の関連付け
   - `server/src/models/User.ts` - ユーザーとチームの関係性調整
   - `server/src/models/TeamContextFortune.ts` - 新規作成

2. **バックエンドサービス:**
   - `server/src/services/fortune.service.ts` - チームコンテキスト運勢生成ロジック追加
   - `server/src/services/team/team-goal.service.ts` - チーム目標情報の運勢生成統合
   - `server/src/services/team/team.service.ts` - チーム情報と運勢の連携

3. **コントローラー:**
   - `server/src/controllers/fortune.controller.ts` - 新規エンドポイント追加
   - `server/src/controllers/team/team.controller.ts` - 運勢情報との連携

4. **バッチ処理:**
   - `server/src/batch/daily-fortune-update.ts` - チームコンテキスト運勢の一括生成対応
   - `server/src/batch/scheduler.ts` - スケジュール調整の可能性

5. **共有定義:**
   - `shared/index.ts` - 新規API定義とデータ型
   - `server/src/types/index.ts` - バックエンド型定義更新

6. **フロントエンドサービス:**
   - `client/src/services/fortune.service.ts` - チーム運勢取得メソッド追加
   - `client/src/services/team.service.ts` - 運勢サービスとの連携

7. **フロントエンドコンポーネント:**
   - `client/src/components/fortune/FortuneCard.tsx` - チームコンテキスト表示対応
   - `client/src/components/fortune/FortuneDetails.tsx` - チーム固有アドバイス表示
   - (新規) `client/src/components/fortune/TeamFortuneRanking.tsx`
   - (新規) `client/src/components/fortune/TeamContextFortuneCard.tsx`
   - (新規) `client/src/components/fortune/TeamCollaborationTips.tsx`

8. **ページコンポーネント:**
   - `client/src/pages/Fortune/index.tsx` - チーム選択UI実装
   - `client/src/pages/Team/index.tsx` - 運勢表示との統合

9. **テスト:**
   - `server/src/tests/controllers/fortune.controller.test.ts` - 新規エンドポイントテスト
   - `server/src/tests/controllers/fortune.controller.team-ranking.test.ts` - チームコンテキスト対応
   - `server/src/tests/services/fortune.service.test.ts` - チームコンテキスト生成テスト

### 潜在的な問題点

1. **データ整合性の課題:**
   - 個人運勢とチーム運勢の同期と更新タイミング管理
   - 日付が変わった際のバッチ更新における整合性確保

2. **パフォーマンスへの影響:**
   - チームコンテキスト追加によるAPIレスポンス時間への影響
   - 複数チーム所属ユーザーの運勢生成負荷増加

3. **UI設計の課題:**
   - 個人/チーム切替による画面の複雑化
   - 直感的なユーザー体験の確保

4. **バッチ処理の効率:**
   - 全ユーザー×全チームのコンビネーションでの運勢生成負荷
   - 処理順序の最適化（個人運勢→チーム運勢の依存関係）

5. **認証と権限の課題:**
   - チーム運勢データへのアクセス権限管理
   - チームメンバーのみが閲覧可能な設計

6. **キャッシュ戦略:**
   - 複数の運勢データタイプに対応したキャッシュ
   - チーム切替時のデータ取得最適化

## リスク管理

- **既存データとの互換性**: 運勢データ重複の防止とマイグレーション
- **パフォーマンス影響**: チームコンテキスト追加によるAPIレイテンシ増加の監視
- **ユーザー体験**: 複雑化するUIによる混乱防止の工夫

## 変更が影響するファイル

### バックエンド
- ✅ `server/src/models/TeamContextFortune.ts` (新規)
- ✅ `server/src/models/DailyFortune.ts`
- ✅ `server/src/models/Team.ts`
- ✅ `server/src/services/fortune.service.ts`
- ✅ `server/src/services/team/team-goal.service.ts`
- ✅ `server/src/controllers/fortune.controller.ts`
- ✅ `server/src/batch/daily-fortune-update.ts`
- ✅ `server/src/routes/fortune.routes.ts`
- ✅ `server/src/batch/scheduler.ts`

### フロントエンド
- ✅ `client/src/services/fortune.service.ts`
- ✅ `client/src/services/team.service.ts`
- ✅ `client/src/pages/Fortune/index.tsx`
- ✅ `client/src/pages/Team/index.tsx`
- ✅ `client/src/components/fortune/FortuneCard.tsx`
- ✅ `client/src/components/fortune/FortuneDetails.tsx`
- ✅ `client/src/components/fortune/TeamContextFortuneCard.tsx` (新規・実装済み)
- ✅ `client/src/components/fortune/TeamCollaborationTips.tsx` (新規・TeamContextFortuneCardに統合済み)
- ✅ `client/src/components/fortune/TeamSelectorDropdown.tsx` (新規・実装済み)
- ✅ `client/src/components/fortune/TeamFortuneRanking.tsx` (新規・実装済み)

### 共有
- ✅ `shared/index.ts`
- ✅ `server/src/types/index.ts`

### テスト
- ⬜ `server/src/tests/controllers/fortune.controller.test.ts`
- ✅ `server/src/tests/controllers/fortune.controller.team-ranking.test.ts`
- ⬜ `server/src/tests/services/fortune.service.test.ts`
- ⬜ `server/src/tests/batch/daily-fortune-update.test.ts`
- ✅ `server/src/tests/utils/test-helpers.ts` (MongoDBConnector追加)

## 実装効果

1. **チーム目標を反映した、より関連性の高い運勢アドバイス**
   - チーム目標の内容に基づいたコンテキスト特化アドバイスの生成
   - チーム協力のヒントにもチーム目標の内容を反映
   - チームメンバー間の五行相性を考慮したアドバイス生成

2. **ユーザーエクスペリエンスの向上**
   - ドロップダウンでチーム選択、タブで個人/チームコンテキスト表示の切替
   - チームメンバーのランキングを視覚的に表示
   - 現在ユーザーの立ち位置がわかるUIで意欲向上

3. **チーム特化表示によるコラボレーション促進**
   - ユーザーのチーム内役割を考慮したアドバイス表示
   - チームメンバー間の五行相性を考慮した協力ヒント
   - チーム目標達成に向けた協力ポイントの明示

4. **パフォーマンスと開発効率の最適化**
   - 統合ダッシュボードAPIによる効率的なデータ取得
   - コンポーネントの再利用と設計改善によるコード品質向上
   - モジュール化された設計による将来的な拡張性確保

## 今後の拡張可能性

- チーム運勢の時系列分析と傾向表示機能
- チーム目標達成予測機能とアドバイス自動調整
- チーム間の相性比較分析と組織最適化提案
- 組織全体の運勢ダッシュボードとトレンド表示

## 残タスクと優先度

### 高優先度
1. **残りのテスト実装**
   - チームコンテキスト運勢生成ロジックのユニットテスト
   - バッチ処理の自動生成テスト

### 中優先度
1. **UI/UXの最適化**
   - モバイル表示の最適化
   - ローディング状態とエラーハンドリングの改善

2. **パフォーマンス最適化**
   - 大規模チームでのパフォーマンステスト
   - キャッシュ戦略の洗練化

### 低優先度
1. **追加機能**
   - チーム運勢履歴表示機能
   - チーム目標達成予測機能
   - チーム間の相性比較分析

## 実装の技術的ポイント

1. **モデル分離とデータ整合性**
   - 個人運勢(`DailyFortune`)とチームコンテキスト運勢(`TeamContextFortune`)を別モデルとして実装
   - ユニーク制約（userId + teamId + date）を設定して重複データを防止
   - 既存の重複データ問題解決のため、常時上書き方式を採用

2. **Claude AIによる高品質アドバイス生成**
   - チーム目標、ユーザー役割、チーム情報を含むプロンプト設計
   - JSON出力形式でアドバイステキストと協力ヒントを分離取得
   - テンプレートベースの実装をフォールバックとして提供（APIエラー時対応）

3. **バッチ処理の最適化**
   - 個人運勢生成後にチームコンテキスト運勢を生成
   - チームメンバーシップを活用した効率的なバッチ処理
   - エラーハンドリングの強化（チームコンテキスト生成エラーは個人運勢に影響しない）

4. **フロントエンドアーキテクチャ**
   - コンポーネント分離による保守性向上
   - 状態管理の最適化（タブ状態とチーム選択状態の連動）
   - 非同期処理と読み込み状態の適切な表示