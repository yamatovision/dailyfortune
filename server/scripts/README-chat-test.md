# チャットストリーミングテスト実行手順

このドキュメントでは、チャットストリーミング機能のテスト方法について説明します。

## 準備

1. サーバーディレクトリに移動します：
   ```
   cd /Users/tatsuya/Desktop/システム開発/DailyFortune/server
   ```

2. 必要なパッケージをインストールします：
   ```
   bash scripts/setup-chat-test.sh
   ```

## テスト実行（方法１：別々のターミナルで）

1. **ターミナル１**でサーバーを起動します：
   ```
   npm run dev
   ```

2. **ターミナル２**で別のシェルを開き、テストスクリプトを実行します：
   ```
   cd /Users/tatsuya/Desktop/システム開発/DailyFortune/server
   node scripts/test-chat-streaming.js
   ```

## テスト実行（方法２：一つのターミナルで）

こちらは一つのターミナルでサーバーをバックグラウンドで起動してテストを実行する方法です：

```bash
cd /Users/tatsuya/Desktop/システム開発/DailyFortune/server

# サーバーをバックグラウンドで起動
npm run dev &

# サーバーの起動を待つ
sleep 5

# テストスクリプトを実行
node scripts/test-chat-streaming.js

# テスト終了後にサーバープロセスを終了
SERVER_PID=$!
kill $SERVER_PID
```

## テスト内容

このテストスクリプトは以下の4つのテストを行います：

1. **通常のチャットリクエスト**：
   - 標準的なPOSTリクエストでチャットメッセージを送信
   - 認証ヘッダーを使用

2. **ストリーミングチャットリクエスト（Fetch API）**：
   - stream=trueパラメータを使用したストリーミングリクエスト
   - レスポンスボディをチャンクごとに読み取り

3. **EventSourceテスト**：
   - ブラウザのEventSourceと同様の動作をシミュレート
   - クエリパラメータでトークンを渡してSSE接続を確立

4. **クエリパラメータ認証テスト**：
   - 認証トークンをヘッダーではなくクエリパラメータで渡す

## テスト結果の見方

テスト終了時に全体の結果が表示されます：

```
========== テスト結果 ==========
1. 通常のチャットリクエスト: 成功 ✅
2. Fetch APIストリーミング: 成功 ✅
3. EventSourceストリーミング: 成功 ✅
4. クエリパラメータ認証: 成功 ✅

全体結果: 全テスト成功 ✅
```

すべてのテストが成功すると、クライアント側でもストリーミングが正しく動作すると考えられます。

## トラブルシューティング

- **認証エラー（401）**：トークン取得が正しく行われているか確認
- **タイムアウトエラー**：サーバーが正しく起動しているか確認
- **解析エラー**：レスポンスの形式が想定と異なる場合に発生

エラーが発生した場合は、サーバーログと合わせて調査してください。