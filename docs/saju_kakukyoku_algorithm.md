# 四柱推命における格局（気質タイプ）を求めるアルゴリズム

## 1. 格局（Kakukyoku）とは

四柱推命において、格局（Kakukyoku/性格タイプ）は日干（Day Master）を中心に、その人の天干と地支の組み合わせによって決定される重要な要素です。格局は「身強（強い日干）」と「身弱（弱い日干）」の大きく2つに分類され、さらにその中で16種類の格局タイプに細分化されます。本ドキュメントでは格局を決定するアルゴリズムの詳細を記述します。

格局は以下のように分類されます：

```
格局
├── 特別格局（約15%）
│   ├── 極身強
│   │   ├── 従旺格（比肩・劫財が多い）
│   │   └── 従強格（偏印・正印が多い）
│   └── 極身弱
│       ├── 従児格（食神・傷官が多い）
│       ├── 従財格（偏財・正財が多い）
│       ├── 従殺格（偏官・正官が多い）
│       └── 従勢格（6つの通変星が均等にある）
└── 普通格局（約85%）
    ├── 身強
    │   ├── 建禄格、月刃格（特殊条件）
    │   ├── 比肩格、劫財格
    │   └── 印緑格、偏印格
    └── 身弱
        ├── 食神格、傷官格
        ├── 偏財格、正財格
        └── 偏官格、正官格
```

## 2. 格局を求める基本手順

格局を決定するプロセスは以下の手順で行われます：

1. 蔵干（地支に内蔵された天干）を求める
2. 天干と地支の通変星（十神関係）を求める
3. 日干の強弱（身強・身弱・中和）を判定する
4. 極身強／極身弱かどうかを判定し、該当する場合は特別格局を特定する
5. 極身強／極身弱に該当しない場合は、普通格局を判定する

## 3. 詳細アルゴリズム

### 3.1 蔵干（地支に内蔵された天干）を求める

各地支には1〜3つの天干が内蔵されています。この内蔵された天干を「蔵干」と呼びます。蔵干には「本気」「中気」「余気」の3種類があり、それぞれ影響力が異なります。

#### 蔵干早見表

| 地支 | 本気（強） | 中気（中） | 余気（弱） |
|------|------------|------------|------------|
| 子   | 癸         | -          | -          |
| 丑   | 己         | 辛         | 癸         |
| 寅   | 甲         | 丙         | 戊         |
| 卯   | 乙         | -          | -          |
| 辰   | 戊         | 乙         | 癸         |
| 巳   | 丙         | 庚         | 戊         |
| 午   | 丁         | 己         | -          |
| 未   | 己         | 丁         | 乙         |
| 申   | 庚         | 壬         | 戊         |
| 酉   | 辛         | -          | -          |
| 戌   | 戊         | 辛         | 丁         |
| 亥   | 壬         | 甲         | -          |

#### 蔵干の重み付け

蔵干の影響力は「本気 > 中気 > 余気」の順に強くなります。実装では以下の重み付けを使用します：

- 本気：1.0（100%）
- 中気：0.7（70%）
- 余気：0.4（40%）

### 3.2 天干と地支の通変星を求める

通変星（十神関係）は、日干と他の天干・地支の蔵干との関係を表し、以下の10種類があります：

| 通変星の種類 | 関係性 | 説明 |
|--------------|--------|------|
| 比肩（ひけん） | 同質同性 | 日干と同じ天干（陰陽も同じ） |
| 劫財（ごうざい） | 同質異性 | 日干と同じ天干の陰陽が逆 |
| 食神（しょくしん） | 我生同性 | 日干が生じる天干で陰陽が同じ |
| 傷官（しょうかん） | 我生異性 | 日干が生じる天干で陰陽が逆 |
| 偏財（へんざい） | 我克同性 | 日干が克する天干で陰陽が同じ |
| 正財（せいざい） | 我克異性 | 日干が克する天干で陰陽が逆 |
| 偏官（へんかん） | 克我同性 | 日干を克する天干で陰陽が同じ |
| 正官（せいかん） | 克我異性 | 日干を克する天干で陰陽が逆 |
| 偏印（へんいん） | 生我同性 | 日干を生じる天干で陰陽が同じ |
| 印緑（いんりょく） | 生我異性 | 日干を生じる天干で陰陽が逆 |

#### 通変星の求め方

1. 日干を中心として、五行の相生相克関係を考える
   - 相生：木→火→土→金→水→木（生じる関係）
   - 相克：木→土→水→火→金→木（克する関係）

2. 陰陽の判定
   - 陽干：甲、丙、戊、庚、壬
   - 陰干：乙、丁、己、辛、癸

3. 日干と他の天干・地支の蔵干との関係を判定

#### 例：日干が「丁」（火）の場合の通変星

| 天干 | 日干「丁」との関係 | 通変星 |
|------|-------------------|--------|
| 丙   | 同質異性（火）     | 劫財   |
| 丁   | 同質同性（火）     | 比肩   |
| 戊   | 我生同性（火→土）  | 食神   |
| 己   | 我生異性（火→土）  | 傷官   |
| 庚   | 我克同性（火→金）  | 偏財   |
| 辛   | 我克異性（火→金）  | 正財   |
| 壬   | 克我同性（水→火）  | 偏官   |
| 癸   | 克我異性（水→火）  | 正官   |
| 甲   | 生我同性（木→火）  | 偏印   |
| 乙   | 生我異性（木→火）  | 印緑   |

### 3.3 日干の強弱（身強・身弱・中和）を判定する

日干の強弱は命式全体のバランスから判定します。文献に基づく具体的な判定条件は以下の通りです：

#### 極身強の判定条件

まず極身強にあてはまるかどうかを判断します。以下の3つの条件（A、B、C）をすべて満たすと、極身強と判断します：

1. **条件A**: 得令（当旺または次旺）の関係の十二支がある
   - 得令とは「月令」を得ることを意味し、日干が月支によって強められる状態
   - 各五行の当旺・次旺となる月支は以下の通り：

   | 日干の五行 | 当旺の月支 | 次旺の月支 |
   |------------|------------|------------|
   | 甲・乙（木）| 寅・卯    | 子・亥    |
   | 丙・丁（火）| 巳・午    | 寅・卯    |
   | 戊・己（土）| 辰・未・戌・丑 | 巳・午 |
   | 庚・辛（金）| 申・酉    | 辰・未・戌・丑 |
   | 壬・癸（水）| 子・亥    | 申・酉    |

2. **条件B**: 地支に日干を強める十二支が2つ以上ある
   - 日干を強める地支は以下の表の通り：

   | 日干 | 日干を強める地支 |
   |------|------------------|
   | 甲・乙 | 寅・卯・子・亥 |
   | 丙・丁 | 巳・午・寅・卯 |
   | 戊・己 | 辰・戌・未・丑、巳・午 |
   | 庚・辛 | 申・酉、辰・戌・未・丑 |
   | 壬・癸 | 子・亥、申・酉 |

3. **条件C**: 天干に日干を強める十干が2つ以上ある
   - 日干を強める天干は以下の表の通り：

   | 日干 | 日干を強める天干 |
   |------|------------------|
   | 甲 | 甲・乙・壬・癸 |
   | 乙 | 乙・甲・壬・癸 |
   | 丙 | 丙・丁・甲・乙 |
   | 丁 | 丁・丙・甲・乙 |
   | 戊 | 戊・己・丙・丁 |
   | 己 | 己・戊・丙・丁 |
   | 庚 | 庚・辛・戊・己 |
   | 辛 | 辛・庚・戊・己 |
   | 壬 | 壬・癸・庚・辛 |
   | 癸 | 癸・壬・庚・辛 |

#### 極身弱の判定条件

極身弱は、次に極身弱にあてはまるかどうかを判断します。以下の3つの条件（A、B、C）すべてに該当する場合に極身弱と判断します：

1. **条件A**: 失令、または月支に日干を弱める十二支がある
   - 失令とは日干が「休」または「囚」の状態に置かれること
   - 各日干にとって失令となる月支は以下の表の通り：

   | 日干 | 失令となる月支（日干を弱める月支） |
   |------|-----------------------------------|
   | 甲・乙 | 申・酉・辰・戌・未・成・己・午  |
   | 丙・丁 | 子・亥・辰・戌・未・成・申・酉  |
   | 戊・己 | 寅・卯・申・酉・子・亥          |
   | 庚・辛 | 巳・午・寅・卯・戌・卯・子・亥  |
   | 壬・癸 | 辰・巳・午・未・寅・卯・戌・丑  |

   - 表中の赤字で示されている月支は特に「失令」に当たる月支（極端に弱まる）

2. **条件B**: 日干を弱める地支が3つ以上ある
   - 各日干を弱める地支は以下の表の通り：

   | 日干 | 日干を弱める地支 |
   |------|------------------|
   | 甲・乙 | 辰・戌・未・成・己・午・申・酉 |
   | 丙・丁 | 辰・戌・未・成・申・酉・子・亥 |
   | 戊・己 | 申・酉・子・亥・寅・卯 |
   | 庚・辛 | 子・亥・寅・卯・巳・午 |
   | 壬・癸 | 寅・卯・辰・戌・未・成・巳・午 |

3. **条件C**: 天干に日干を弱める十干が2つ以上ある
   - 各日干を弱める天干は以下の表の通り：

   | 日干 | 日干を弱める天干 |
   |------|------------------|
   | 甲 | 丙・丁・戊・己・庚・辛 |
   | 乙 | 丙・丁・戊・己・庚・辛 |
   | 丙 | 戊・己・庚・辛・壬・癸 |
   | 丁 | 戊・己・庚・辛・壬・癸 |
   | 戊 | 庚・辛・壬・癸・甲・乙 |
   | 己 | 庚・辛・壬・癸・甲・乙 |
   | 庚 | 壬・癸・甲・乙・丙・丁 |
   | 辛 | 壬・癸・甲・乙・丙・丁 |
   | 壬 | 甲・乙・丙・丁・戊・己 |
   | 癸 | 甲・乙・丙・丁・戊・己 |

### 3.4 特別格局と普通格局の判定

#### 特別格局の判定基準

特別格局は「極身強」または「極身弱」に該当し、かつ通変星の分布に特徴がある場合に判定されます。特別格局の判定手順は以下の通りです：

1. まず条件A、B、Cに基づいて「極身強」または「極身弱」であることを確認する
2. 「極身強」または「極身弱」に該当する場合、通変星の分布を調べる
3. 通変星に偏りがある場合、その特徴に応じて特別格局のタイプを判定する

通変星の数で格局の種類が決まります。特に命式の中で「通変星の数が最も多いか」「均等にあるか」によって判定します。

#### 極身強の特別格局の種類と特徴

極身強の条件A〜Cすべてにあてはまった人は極身強になりますが、さらに何のタイプになるかは、命式の通変星の分布により以下のように判定します：

1. **従旺格**（じゅうおうかく）
   - 特徴：主体性があり、自分の思った通りに人生を突き進む
   - 判定条件：命式に比肩と劫財が多い
   - 表記例：命式の通変星に比肩と劫財が多い = 従旺格

2. **従強格**（じゅうきょうかく）
   - 特徴：独自の人生観を持ち、学識の充実した人生を歩む
   - 判定条件：命式に偏印と印緑が多い
   - 表記例：命式に偏印と印緑が多い = 従強格

#### 極身弱の特別格局の種類と特徴

極身弱の条件A、B、Cすべてにあてはまった人は極身弱になりますが、さらに何のタイプになるかは、命式の通変星の分布により以下のように判定します：

1. **従児格**（じゅうじかく）
   - 特徴：社交的で頭の回転が速く、鋭い感性と人生観を持つ
   - 判定条件：命式に食神と傷官が多い
   - 表記例：命式に食神と傷官が多い = 従児格

2. **従財格**（じゅうざいかく）
   - 特徴：とても強い財運を持ち、人間関係にも恵まれる
   - 判定条件：命式に偏財と正財が多い
   - 表記例：命式に偏財と正財が多い = 従財格

3. **従殺格**（じゅうさつかく）
   - 特徴：忍耐強く封建的な世界を好み、目上につき従う
   - 判定条件：命式に偏官と正官が多い
   - 表記例：命式に偏官と正官が多い = 従殺格

4. **従勢格**（じゅうせいかく）
   - 特徴：円満な性格で、環境や状況に柔軟に対応していく
   - 判定条件：命式に食神、傷官、偏財、正財、偏官、正官の六種類の通変星が均等にある
   - 表記例：命式に食神、傷官、偏財、正財、偏官、正官が均等にある = 従勢格

通変星の数で格局の種類が決まります。特に命式の中で「通変星の数が最も多いか」「均等にあるか」によって判定します。例えば、正官と偏官の数が多い場合は「従殺格」となります。なお、「従旺格」と呼ばれる格局もありますが、本書では省略しています。

#### 「多い」の定義

- 通変星が「多い」とは、命式全体（年・月・日・時の天干と地支の蔵干）の中で当該通変星ペアの数が他と比較して明らかに多い場合
- 一般的には全体の30%以上を占める場合とされる
- ペアの合計数で判断（例：比肩と劫財の合計数）

### 3.5 普通格局の判定と優先順位

普通格局は以下の優先順位で判断します：

1. **建禄格**の条件を確認
   - 日干と月支の特殊な組み合わせ（例：甲日干と寅月支）

2. **月刃格**の条件を確認
   - 日干と月支の特殊な組み合わせ（例：甲日干と卯月支）

3. 月支の蔵干と同じ五行の天干が月干にあるか確認
   - ある場合、その天干の十神関係で格局を決定

4. 月支の蔵干と同じ五行の天干が年干か時干に出ているか確認
   - ある場合、その天干の十神関係で格局を決定
   - 複数出ている場合は、月支の蔵干の「本気 > 中気 > 余気」の順で優先

5. 上記の条件に当てはまらない場合、「月支蔵干深浅表」を使って格局を求める

#### 建禄格と月刃格の組み合わせ

| 日干 | 建禄格（月支） | 月刃格（月支） |
|------|----------------|----------------|
| 甲   | 寅             | 卯             |
| 乙   | 卯             | 寅             |
| 丙   | 巳             | 午             |
| 丁   | 午             | 巳             |
| 戊   | 辰             | 未             |
| 己   | 未             | 辰             |
| 庚   | 申             | 酉             |
| 辛   | 酉             | 申             |
| 壬   | 亥             | 子             |
| 癸   | 子             | 亥             |

#### 普通格局の種類（十神に基づく）

| 通変星 | 格局タイプ | 特徴 |
|--------|------------|------|
| 比肩   | 比肩格     | 同じ立場の人と協力し合い、対等な関係を構築する |
| 劫財   | 劫財格     | 自立心が強く、競争心のある気質 |
| 食神   | 食神格     | 鋭い感覚を持ち快楽主義者で、のびのびと生きる |
| 傷官   | 傷官格     | 独自の感性の持ち主で、専門技術の習得にも長ける |
| 偏財   | 偏財格     | 社交的で義理人情に厚く、物質生活を重んじる |
| 正財   | 正財格     | 現実的な合理主義者で、堅実な価値判断をする |
| 偏官   | 偏官格     | 正義感にあふれ、強い者を抑えて弱い者を助ける |
| 正官   | 正官格     | まじめで大言を表に出さず、家に規律や礼儀を重んじる |
| 偏印   | 偏印格     | 知的好奇心が旺盛で、内面世界の探求を重視する |
| 正印   | 印緑格     | 好奇心旺盛で、知識を吸収することに喜びを感じる |



## 5. 実際の計算例

### 例：1985年5月8日06時31分生まれの場合

#### 1. 命式の取得
- 年柱：乙丑（蔵干：己土・辛金・癸水）
- 月柱：辛巳（蔵干：丙火・庚金・戊土）
- 日柱：丁未（蔵干：己土・丁火・乙木）
- 時柱：癸卯（蔵干：乙木）
- 日干：丁（火）

#### 2. 通変星の計算
日干「丁」と各天干・蔵干との関係：
- 年干「乙」：印緑（木生火、陰陽が異なる）
- 年支蔵干「己」：傷官（火生土、陰陽が異なる）
- 年支蔵干「辛」：正財（火克金、陰陽が異なる）
- 年支蔵干「癸」：正官（水克火、陰陽が異なる）
- 月干「辛」：正財（火克金、陰陽が異なる）
- 月支蔵干「丙」：劫財（火同士、陰陽が異なる）
- 月支蔵干「庚」：偏財（火克金、陰陽が同じ）
- 月支蔵干「戊」：食神（火生土、陰陽が同じ）
- 日支蔵干「己」：傷官（火生土、陰陽が異なる）
- 日支蔵干「丁」：比肩（火同士、陰陽が同じ）
- 日支蔵干「乙」：印緑（木生火、陰陽が異なる）
- 時干「癸」：正官（水克火、陰陽が異なる）
- 時支蔵干「乙」：印緑（木生火、陰陽が異なる）

通変星の集計：
- 比肩：1
- 劫財：1
- 食神：1
- 傷官：2
- 偏財：1
- 正財：2
- 偏官：0
- 正官：2
- 偏印：0
- 印緑：3

#### 3. 身強・身弱の判定
- 条件A：得令 - 丁火は巳月に強まる（+2）
- 条件B：巳支が日干を強める（+1）
- 条件B：未支が日干を強める（+1）
- 条件C：丙天干が日干を強める（+1）
- 条件D/E：三方会局や三合会局はなし（+0）

総合スコア：+5（身強）

#### 4. 特別格局の判定
- スコア+5で極身強の可能性
- 通変星の分布：印緑が3/13で約23%
- 印緑と偏印の合計が3/13で約23%（30%未満）
- 特定の通変星ペアが30%を超えていないため、特別格局ではない

#### 5. 普通格局の判定
1. 建禄格の条件：丁日干の建禄格は午月支（条件不一致）
2. 月刃格の条件：丁日干の月刃格は巳月支（条件一致）
   → 月刃格と判定

最終結果：
- 格局タイプ：「月刃格」
- カテゴリ：「普通格局」
- 身強・身弱：「身強」
- 説明：「プライドが高く、自分の世界や価値観を重視する気質タイプです。独自の判断基準を持ち、自律性が高い特徴があります。」

## 6. 実装上の考慮事項

### 6.1 データベースと参照テーブル

- **蔵干早見表**: 地支に内蔵された天干の情報
- **通変星早見表**: 日干と他の天干の十神関係
- **月支蔵干深浅表**: 月支の蔵干の深さに基づく格局判定用
- **五行の相生相克関係**: 五行間の生克関係マトリックス
- **十干の五行属性**: 各天干が持つ五行の情報

### 6.2 性能と最適化

- 通変星計算と集計は事前に行い、結果をキャッシュする
- 格局判定は四柱推命計算の一部として一度だけ行う
- 通変星の重み付け計算は精度と処理速度のバランスを考慮する

### 6.3 拡張性

- 将来的な用神（Yojin）計算との連携
- 季節や月による影響の詳細な調整
- 個人の運勢アドバイスとの連携機能

## 7. 用神・喜神・忌神・仇神の早見表と相互関係

命式において用神（Yojin）は運気を高める要素であり、忌神（Kijin）は避けるべき要素です。用神と喜神は運気を高め、忌神と仇神は運気を下げます。

### 7.1 用神・喜神・忌神・仇神の関係

四柱推命における用神・喜神・忌神・仇神の相互関係は以下の通りです：

- **用神**：命式において最も必要とされる五行要素
- **喜神**：用神を生じる五行要素
- **忌神**：用神を壊す五行要素
- **仇神**：忌神を生じる五行要素

これらの要素は五行の相生相克の関係に基づいています：
- 木→火→土→金→水→木（生じる関係）
- 木→土→水→火→金→木（克する関係）

### 7.2 用神の選定方法

用神の選定には「多い通変星」と「格局タイプ」と「身強/身弱」の3つの要素を考慮する必要があります。以下に示す詳細な表は、参照画像（IMG_4048.jpg、IMG_4049.jpg、IMG_4053.jpg）に基づいて作成されたものです。

各格局タイプと身強/身弱の組み合わせに応じて、さらに「多い通変星」ごとに最適な用神が決定されます。下記の早見表を参照することで、個人に最適な用神を特定できます。

#### 特別格局の用神・喜神・忌神・仇神


| 格局タイプ | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| 従旺格 | 比劫 | 印 | 官殺 | 財 |
| 従強格 | 印 | 比劫 | 財 | 食傷 |
| 従児格 | 食傷 | 財 | 印 | 比劫 |
| 従財格 | 財 | 食傷 | 比劫 | 印 |
| 従殺格 | 官殺 | 財 | 印 | 比劫 |
| 従勢格 | 財 | 官殺・食傷 | 比劫 | 印 |

#### 普通格局の用神・喜神・忌神・仇神

以下に普通格局の詳細な用神判定表を示します。この早見表は参照画像（IMG_4048.jpg、IMG_4049.jpg、IMG_4053.jpg）の解析と統合に基づき作成されたもので、格局タイプ、身強/身弱の状態、多い通変星の3つの条件から用神・喜神・忌神・仇神を判定できます。

### 建禄格・月刃格の早見表

| 身強弱 | 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-------|-----------|------|------|------|------|
| 身強  | 比劫      | 官殺 | 財   | 比劫 | 印   |
| 身強  | 印        | 財   | 食傷 | 比劫 | 印   |
| 身強  | 食傷      | 財   | 官殺 | 比劫 | 印   |
| 身強  | 財        | 官殺 | 財   | 印   | 比劫 |
| 身強  | 官殺      | 食傷 | 財   | 印   | 比劫 |
| 身弱  | 官殺      | 印   | 比劫 | 財   | 食傷 |
| 身弱  | 財        | 比劫 | 印   | 官殺 | 財   |
| 身弱  | 食傷      | 印   | 比劫 | 財   | 食傷 |

### 食神格・傷官格の早見表

| 身強弱 | 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-------|-----------|------|------|------|------|
| 身強  | 比劫      | 食傷 | 財   | 印   | 比劫 |
| 身強  | 印        | 財   | 食傷 | 比劫 | 印   |
| 身強  | 食傷      | 財   | 官殺 | 比劫 | 印   |
| 身強  | 財        | 官殺 | 財   | 印   | 比劫 |
| 身強  | 官殺      | 食傷 | 財   | 印   | 比劫 |
| 身弱  | 官殺      | 印   | 比劫 | 財   | 食傷 |
| 身弱  | 財        | 比劫 | 印   | 官殺 | 財   |
| 身弱  | 食傷      | 印   | 比劫 | 財   | 食傷 |

### 偏財格・正財格の早見表

| 身強弱 | 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-------|-----------|------|------|------|------|
| 身強  | 比劫      | 食傷 | 財   | 印   | 比劫 |
| 身強  | 印        | 財   | 食傷 | 比劫 | 印   |
| 身強  | 食傷      | 財   | 官殺 | 比劫 | 印   |
| 身強  | 財        | 官殺 | 財   | 印   | 比劫 |
| 身強  | 官殺      | 食傷 | 財   | 印   | 比劫 |
| 身弱  | 官殺      | 印   | 比劫 | 財   | 食傷 |
| 身弱  | 財        | 比劫 | 印   | 官殺 | 財   |
| 身弱  | 食傷      | 印   | 比劫 | 財   | 食傷 |



## 正官格・偏官格の用神・喜神・忌神・仇神早見表

| 身強/身弱 | 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|-----------|------|------|------|------|
| 身弱 | 食傷 | 印 | 比劫 | 財 | 食傷 |
| 身弱 | 財 | 比劫 | 印 | 官殺 | 財 |
| 身弱 | 官殺 | 印 | 比劫 | 財 | 食傷 |
| 身強 | 官殺 | 食傷 | 財 | 印 | 比劫 |
| 身強 | 財 | 官殺 | 財 | 印 | 比劫 |
| 身強 | 食傷 | 財 | 官殺 | 比劫 | 印 |
| 身強 | 印 | 財 | 食傷 | 比劫 | 印 |
| 身強 | 比劫 | 官殺 | 財 | 比劫 | 印 |

## 印緑格・偏印格の用神・喜神・忌神・仇神早見表

| 身強/身弱 | 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|-----------|------|------|------|------|
| 身弱 | 食傷 | 印 | 比劫 | 財 | 食傷 |
| 身弱 | 財 | 比劫 | 印 | 官殺 | 財 |
| 身弱 | 官殺 | 印 | 比劫 | 財 | 食傷 |
| 身強 | 官殺 | 食傷 | 財 | 印 | 比劫 |
| 身強 | 財 | 官殺 | 財 | 印 | 比劫 |
| 身強 | 食傷 | 財 | 官殺 | 比劫 | 印 |
| 身強 | 印 | 財 | 食傷 | 比劫 | 印 |
| 身強 | 比劫 | 官殺 | 財 | 比劫 | 印 |



**重要**: 上記の表における通変星のペアは以下のように対応しています：
- 比劫 = 比肩・劫財
- 印 = 偏印・正印
- 食傷 = 食神・傷官
- 財 = 偏財・正財
- 官殺 = 偏官・正官

**重要**: 用神が「財」「官」「印」「比肩」などのペアとして示されている場合（例：比肩・劫財）、命式内でより多く出現している方を正式な用神として選定します。

## 8. 用神判定アルゴリズムの実装

以下に、上記の詳細な早見表に基づく用神判定アルゴリズムの実装例を示します。このアプローチはテーブル駆動型設計を採用し、格局タイプ、身強弱、多い通変星の3つの要素から用神・喜神・忌神・仇神を効率的に判定します。

```typescript
/**
 * 早見表に基づいて用神判定を行う関数
 * @param kakukyokuType 格局タイプ（建禄格、月刃格など）
 * @param isStrong 身強かどうか（true=身強、false=身弱）
 * @param dominantTenGod 多い通変星（比劫、印、食傷、財、官殺）
 * @returns 用神・喜神・忌神・仇神のセット
 */
function determineYojinFromLookupTable(
  kakukyokuType: string,
  isStrong: boolean,
  dominantTenGod: string
): { yojin: string; kijin: string; kijin: string; kyujin: string } {
  // 早見表データ（上記の表に基づく）
  const yojinLookupTable = {
    // 建禄格・月刃格
    'kenroku_getsujin': {
      'strong': {
        'hikoh': { yojin: '官殺', kijin: '財', kijin: '比劫', kyujin: '印' },
        'in': { yojin: '財', kijin: '食傷', kijin: '比劫', kyujin: '印' },
        'shokusho': { yojin: '財', kijin: '官殺', kijin: '比劫', kyujin: '印' },
        'zai': { yojin: '官殺', kijin: '財', kijin: '印', kyujin: '比劫' },
        'kansatsu': { yojin: '食傷', kijin: '財', kijin: '印', kyujin: '比劫' }
      },
      'weak': {
        'kansatsu': { yojin: '印', kijin: '比劫', kijin: '財', kyujin: '食傷' },
        'zai': { yojin: '比劫', kijin: '印', kijin: '官殺', kyujin: '財' },
        'shokusho': { yojin: '印', kijin: '比劫', kijin: '財', kyujin: '食傷' }
      }
    },
    
    // 食神格・傷官格
    'shokushin_shokan': {
      'strong': {
        'hikoh': { yojin: '食傷', kijin: '財', kijin: '印', kyujin: '比劫' },
        'in': { yojin: '財', kijin: '食傷', kijin: '比劫', kyujin: '印' },
        'shokusho': { yojin: '財', kijin: '官殺', kijin: '比劫', kyujin: '印' },
        'zai': { yojin: '官殺', kijin: '財', kijin: '印', kyujin: '比劫' },
        'kansatsu': { yojin: '食傷', kijin: '財', kijin: '印', kyujin: '比劫' }
      },
      'weak': {
        'kansatsu': { yojin: '印', kijin: '比劫', kijin: '財', kyujin: '食傷' },
        'zai': { yojin: '比劫', kijin: '印', kijin: '官殺', kyujin: '財' },
        'shokusho': { yojin: '印', kijin: '比劫', kijin: '財', kyujin: '食傷' }
      }
    },
    
    // 偏財格・正財格
    'henzai_seizai': {
      'strong': {
        'hikoh': { yojin: '食傷', kijin: '財', kijin: '印', kyujin: '比劫' },
        'in': { yojin: '財', kijin: '食傷', kijin: '比劫', kyujin: '印' },
        'shokusho': { yojin: '財', kijin: '官殺', kijin: '比劫', kyujin: '印' },
        'zai': { yojin: '官殺', kijin: '財', kijin: '印', kyujin: '比劫' },
        'kansatsu': { yojin: '食傷', kijin: '財', kijin: '印', kyujin: '比劫' }
      },
      'weak': {
        'kansatsu': { yojin: '印', kijin: '比劫', kijin: '財', kyujin: '食傷' },
        'zai': { yojin: '比劫', kijin: '印', kijin: '官殺', kyujin: '財' },
        'shokusho': { yojin: '印', kijin: '比劫', kijin: '財', kyujin: '食傷' }
      }
    },
    
    // その他の格局タイプも同様に追加...
  };
  
  // 入力を内部表現に変換
  const formatKey = convertKakukyokuTypeToKey(kakukyokuType);
  const strengthKey = isStrong ? 'strong' : 'weak';
  const tenGodKey = convertTenGodToKey(dominantTenGod);
  
  // 早見表から情報を取得
  if (
    yojinLookupTable[formatKey] && 
    yojinLookupTable[formatKey][strengthKey] && 
    yojinLookupTable[formatKey][strengthKey][tenGodKey]
  ) {
    return yojinLookupTable[formatKey][strengthKey][tenGodKey];
  }
  
  // 該当する情報がない場合のデフォルト値
  return { yojin: '不明', kijin: '不明', kijin: '不明', kyujin: '不明' };
}

/**
 * 格局タイプを内部キーに変換する補助関数
 */
function convertKakukyokuTypeToKey(kakukyokuType: string): string {
  // 格局タイプを内部表現のキーに変換
  const mapping: Record<string, string> = {
    '建禄格': 'kenroku_getsujin',
    '月刃格': 'kenroku_getsujin',
    '食神格': 'shokushin_shokan',
    '傷官格': 'shokushin_shokan',
    '偏財格': 'henzai_seizai',
    '正財格': 'henzai_seizai',
    // 他の格局タイプも同様にマッピング
  };
  
  return mapping[kakukyokuType] || 'unknown';
}

/**
 * 多い通変星を内部キーに変換する補助関数
 */
function convertTenGodToKey(tenGod: string): string {
  // 通変星を内部表現のキーに変換
  const mapping: Record<string, string> = {
    '比肩': 'hikoh',
    '劫財': 'hikoh',
    '偏印': 'in',
    '正印': 'in',
    '食神': 'shokusho',
    '傷官': 'shokusho',
    '偏財': 'zai',
    '正財': 'zai',
    '偏官': 'kansatsu',
    '正官': 'kansatsu'
  };
  
  return mapping[tenGod] || 'unknown';
}
```

このアルゴリズム実装では、早見表データをオブジェクトとして定義し、与えられた条件（格局タイプ、身強弱、多い通変星）に基づいて適切な用神・喜神・忌神・仇神を効率的に取得します。テーブル駆動型設計により、条件分岐が少なく、メンテナンス性に優れた実装が可能です。

### 用神判定のトータルフロー

1. 四柱推命の計算をもとに格局（Kakukyoku）を判定
   - 身強/身弱を判定
   - 格局タイプを特定（建禄格、月刃格、食神格など）
   - 多い通変星を特定（比劫、印、食傷、財、官殺）

2. 早見表に基づいて用神・喜神・忌神・仇神を決定
   - 格局タイプ、身強/身弱、多い通変星の3条件に基づいて判定
   - 通変星ペア（比劫、印など）から具体的な通変星（比肩、劫財など）を特定

3. 運勢解釈へ適用
   - 用神を基準として個人の運勢やアドバイスを導出
   - 喜神を取り入れ、忌神・仇神を避ける方向性を提案

### 具体的な実装への注意点

- 命式データから格局タイプを正確に判定する必要がある
- 身強/身弱の判定は蔵干の影響も含めて行う
- 多い通変星の判定には蔵干の重み（本気・中気・余気）を考慮する
- 用神が通変星ペアとして示されている場合は、命式内でより多く出現している方を選定する
- 早見表データは定期的に検証・更新することが望ましい

このアルゴリズムを実装することで、四柱推命における格局と用神の判定を自動化し、より精度の高い運勢判断を提供することが可能になります。

### 7.3 用神の具体的な決定手順

以下に用神を求める正確な手順を記載します：

1. **通変星の集計**: まず自分の命式の通変星（天干と地支の蔵干の本気のみ）の数を数える
   - 重要: 蔵干の中気と余気は含めず、本気だけを集計する
   - 例: 甲、乙、丙などの天干と、地支の本気である蔵干の十神関係を数える

2. **通変星ペアの集計**: 以下の通変星ペアごとに集計する
   - 「比肩と劫財」のペア合計
   - 「食神と傷官」のペア合計
   - 「偏財と正財」のペア合計
   - 「偏官と正官」のペア合計
   - 「偏印と正印」のペア合計

3. **格局の確認**: 早見表で自分の格局と身強/身弱状態を確認する
   - 例: 「従財格」で「極身弱」の場合

4. **多い通変星の特定**: 命式内で最も数が多い通変星ペアを特定する
   - 例: 「偏財と正財」が最も多い通変星ペア

5. **用神の特定**: 格局と多い通変星から対応する用神を特定する
   - 例: 「従財格」（極身弱）で「偏財・正財」が多い場合、用神は「比肩・劫財」
   
6. **具体的な用神の決定**: 特定された用神ペア内でどちらが正式な用神かを決定する
   - 例: 「比肩・劫財」が用神のカテゴリの場合、命式内で「比肩」と「劫財」のどちらが多いかを確認
   - 多い方を正式な用神として採用（例: 「比肩」が多ければ「比肩」が正式な用神）

7. **記録**: 特定された用神、喜神、忌神、仇神を個人データ表に記録する

### 7.4 用神・喜神・忌神・仇神の早見表

以下の表は、格局タイプと身強/身弱の状態に応じた用神、喜神、忌神、仇神の関係を示しています。これらの表は参照画像に基づいて正確に作成されています。

#### A. 特別格局の場合
| 格局タイプ | 身強/身弱 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|-----------|------|------|------|------|
| 従旺格 | 極身強 | 食神・傷官 | 比肩・劫財 | 偏印・正印 | 偏財・正財・偏官・正官 |
| 従強格 | 極身強 | 偏官・正官 | 偏印・正印 | 比肩・劫財 | 食神・傷官 |
| 従児格 | 極身弱 | 偏印・正印 | 食神・傷官 | 偏財・正財・偏官・正官 | 比肩・劫財 |
| 従財格 | 極身弱 | 比肩・劫財 | 偏財・正財 | 偏官・正官・食神・傷官 | 偏印・正印 |
| 従殺格 | 極身弱 | 食神・傷官 | 偏官・正官 | 偏印・正印・比肩・劫財 | 偏財・正財 |
| 従勢格 | 極身弱 | 最も少ない通変星 | - | - | - |

#### B. 普通格局の場合

##### B-1. 建禄格・月刃格（身強）
| 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| - | 食神・傷官・偏財・正財・偏官・正官 | 比肩・劫財・偏印・正印 | - | - |

##### B-2. 偏印格・正印格（身強）
| 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| - | 比肩・劫財 | 偏印・正印 | 偏財・正財・偏官・正官 | 食神・傷官 |

##### B-3. 偏官格・正官格（身弱）
| 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| - | 偏印・正印 | 偏官・正官 | 比肩・劫財・食神・傷官 | 偏財・正財 |

##### B-4. 偏財格・正財格（身弱）
| 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| - | 比肩・劫財 | 偏財・正財 | 偏官・正官・偏印・正印 | 食神・傷官 |

##### B-5. 食神格・傷官格（身強/身弱）
| 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| 身強 | 偏財・正財・偏官・正官 | 食神・傷官 | 比肩・劫財 | 偏印・正印 |
| 身弱 | 偏印・正印 | 食神・傷官 | 偏財・正財・偏官・正官 | 比肩・劫財 |

##### B-6. 比肩格・劫財格（身強/身弱）
| 多い通変星 | 用神 | 喜神 | 忌神 | 仇神 |
|-----------|------|------|------|------|
| 身強 | 食神・傷官・偏財・正財・偏官・正官 | 比肩・劫財 | 偏印・正印 | - |
| 身弱 | 偏印・正印 | 比肩・劫財 | 食神・傷官・偏財・正財 | 偏官・正官 |

#### C. 通変星の略称解説
- **比肩** = 比肩（同じ五行・同じ陰陽）・劫財（同じ五行・異なる陰陽）
- **印** = 偏印（生じる五行・同じ陰陽）・正印（生じる五行・異なる陰陽）
- **財** = 偏財（克する五行・同じ陰陽）・正財（克する五行・異なる陰陽）
- **官殺** = 偏官（克される五行・同じ陰陽）・正官（克される五行・異なる陰陽）
- **食傷** = 食神（生じさせる五行・同じ陰陽）・傷官（生じさせる五行・異なる陰陽）


### 7.5 命式中の蔵干（隠れた天干）の影響

蔵干（地支に隠れた天干）は、その重要度に応じて以下のように分類されます：
- **本気**（主要蔵干）：最も影響力が強い蔵干
- **中気**（第二蔵干）：二番目に影響力がある蔵干
- **余気**（第三蔵干）：三番目に影響力がある蔵干

**重要**: 用神を求める際には、蔵干の「本気」のみを考慮し、「中気」と「余気」は集計に含めません。これは用神を正確に特定するための伝統的な方法です。

一方、格局判定や身強弱の決定など、その他の計算では、蔵干に以下の重み付けを適用することもあります：
- 本気：1.0（100%）
- 中気：0.7（70%）
- 余気：0.4（40%）

例えば、「丑」の地支には「己」（本気）、「辛」（中気）、「癸」（余気）の蔵干がありますが、用神計算では「己」のみを考慮します。

格局と身強弱の組み合わせに基づいて、適切な用神を選定することで、命式のバランスを整え、運気を高めることができます。用神は日干のエネルギーを調整する役割を持ち、身強の場合は日干を抑制する要素、身弱の場合は日干を強化する要素が選ばれます。

## 8. 参考文献と関連資料

- 韓国式四柱推命の理論書
- 伝統的な中国式四柱推命の文献
- [四柱推命アドバイス戦略](/docs/四柱推命アドバイス戦略.md)
- [用神アルゴリズム](/docs/saju_yojin_algorithm.md)
- [格局と用神の実装計画](/docs/kakukyoku_yojin_implementation_plan.md)