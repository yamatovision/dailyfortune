# チャット機能実装タスク

> **作成日**: 2025/04/09
> **優先度**: 高

## 概要

統合チャット機能は、ユーザーが四柱推命に基づいた運勢相談、チームメンバー相性相談、チーム目標相談をAIとリアルタイムで行えるようにする機能です。このドキュメントでは、チャット機能の実装に必要なすべてのタスクと依存関係をカバーしています。

## 依存関係グラフ

```
1. 共有定義 (型定義/APIパス)
   ↓
2. バックエンドモデル実装
   ↓
3. バックエンドサービス実装 ← AIサービス連携
   ↓
4. バックエンドコントローラー実装
   ↓
5. バックエンドルート実装 ← 認証ミドルウェア依存
   ↓
6. フロントエンドAPI連携サービス実装
   ↓
7. フロントエンドチャットコンポーネント実装
   ↓
8. フロントエンドページ統合
```

## 実装タスク詳細

### 1. 共有定義の更新 (shared/index.ts)

- [x] CHAT 定数の追加（API仕様書に基づくパス定義）
- [x] チャット関連の型定義追加（IChatMessage, IChat, ChatMode enum等）
- [x] チャットリクエスト/レスポンス型の定義

### 2. バックエンドモデル実装 (server/src/models/ChatHistory.ts)

- [ ] モデルスキーマ定義
  - ユーザーID
  - チャットタイプ（personal, team_member, team_goal）
  - メッセージ配列
  - コンテキストデータ
  - 関連情報（メンバーID、目標ID）
  - トークンカウント
  - 作成日時、更新日時、最終メッセージ日時
- [ ] モデルメソッド実装
  - メッセージ追加
  - トークン数計算
  - 履歴クエリ
- [ ] インデックス設定

### 3. バックエンドサービス実装 (server/src/services/chat.service.ts)

- [ ] メッセージ処理サービス
  - ユーザーメッセージの処理
  - AIコンテキスト構築
  - AIレスポンス生成
  - メッセージ保存
- [ ] モード切替サービス
  - モード別コンテキスト生成
  - ウェルカムメッセージ生成
- [ ] 履歴管理サービス
  - 履歴取得
  - 履歴クリア

### 4. AIサービス連携 (server/src/services/claude-ai.service.ts)

- [ ] AIプロンプト生成
  - モード別プロンプトテンプレート
  - コンテキスト情報埋め込み
- [ ] API連携実装
  - リクエスト送信
  - レスポンス解析
  - エラーハンドリング
- [ ] レート制限管理
  - ユーザープラン別の制限設定
  - 使用量追跡

### 5. バックエンドコントローラー実装 (server/src/controllers/chat.controller.ts)

- [ ] メッセージ送信コントローラー
  - リクエスト検証
  - サービス呼び出し
  - レスポンス整形
- [ ] 履歴取得コントローラー
  - クエリパラメータ処理
  - ページネーション処理
  - フィルタリング処理
- [ ] 履歴クリアコントローラー
  - パラメータ検証
  - 削除処理
- [ ] モード切替コントローラー
  - モード検証
  - コンテキスト更新

### 6. バックエンドルート実装 (server/src/routes/chat.routes.ts)

- [ ] ルート定義
  - メッセージ送信ルート
  - 履歴取得ルート
  - 履歴クリアルート
  - モード切替ルート
- [ ] 認証ミドルウェア適用
- [ ] バリデーションミドルウェア設定

### 7. フロントエンドAPI連携サービス実装 (client/src/services/chat.service.ts)

- [ ] API連携メソッド実装
  - メッセージ送信
  - 履歴取得
  - 履歴クリア
  - モード切替
- [ ] チャット状態管理
  - ローカルストレージとの連携
  - エラーハンドリング

### 8. フロントエンドチャットコンポーネント実装 (client/src/components/chat/*)

- [ ] ChatContainer コンポーネント
  - メッセージリスト表示
  - 入力フォーム
  - 送信機能
- [ ] ChatMessage コンポーネント
  - ユーザー/AIメッセージ表示
  - メッセージフォーマット（Markdown対応）
- [ ] ChatModeSelector コンポーネント
  - モード切替UI
  - アクティブモード表示
- [ ] MemberSelector コンポーネント
  - チームメンバー一覧表示
  - メンバー選択機能
- [ ] ChatInput コンポーネント
  - テキスト入力
  - 送信ボタン
  - 音声入力（WebSpeech API）

### 9. フロントエンド音声入力実装

- [ ] WebSpeech API 連携
  - 音声認識機能実装
  - ブラウザ互換性対応
  - エラーハンドリング

### 10. フロントエンドページ統合 (client/src/pages/Chat/index.tsx)

- [ ] チャットコンポーネント統合
  - レイアウト調整
  - レスポンシブデザイン
- [ ] 状態管理実装
  - ローディング状態
  - エラー状態
  - メッセージ履歴
- [ ] ナビゲーション連携
  - 戻るボタン
  - 保存機能

## テスト計画

### バックエンドテスト

1. モデルテスト (server/src/tests/models/ChatHistory.test.ts)
   - スキーマバリデーションテスト
   - インデックス動作確認
   - メソッドテスト

2. サービステスト (server/src/tests/services/chat.service.test.ts)
   - モード切替テスト
   - メッセージ処理テスト
   - AIコンテキスト構築テスト
   - 履歴管理テスト

3. コントローラーテスト (server/src/tests/controllers/chat.controller.test.ts)
   - リクエスト処理テスト
   - レスポンス整形テスト
   - エラーハンドリングテスト

4. 統合テスト (server/src/tests/routes/chat.routes.test.ts)
   - エンドツーエンドAPIテスト
   - 認証テスト
   - レート制限テスト

### フロントエンドテスト

1. サービステスト
   - API連携テスト
   - エラーハンドリングテスト
   - ローカルストレージ連携テスト

2. コンポーネントテスト
   - レンダリングテスト
   - イベントハンドリングテスト
   - ユーザー操作テスト

3. 統合テスト
   - ページ全体のテスト
   - ナビゲーションテスト
   - エンドツーエンドテスト

## デプロイ前チェックリスト

- [ ] すべてのテストが通過していることを確認
- [ ] レート制限が正しく設定されていることを確認
- [ ] エラーハンドリングが適切に実装されていることを確認
- [ ] 音声入力がサポートされているブラウザで動作確認
- [ ] レスポンシブデザインの確認
- [ ] セキュリティチェック（認証、CSRF対策等）
- [ ] パフォーマンスチェック
- [ ] アクセシビリティチェック