# 管理者システム - データフローと実装ガイド

このドキュメントは、DailyFortuneアプリケーションの管理者システムにおけるデータフローと実装ガイドを提供します。

## 1. ユーザー管理フロー

### 1.1 SuperAdmin によるユーザー作成フロー

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│   SuperAdmin   │    │    Firebase    │    │    MongoDB     │
│  管理者画面     │    │  Authentication │    │   データベース   │
└───────┬────────┘    └───────┬────────┘    └───────┬────────┘
        │                     │                     │
        │ ユーザー作成リクエスト  │                     │
        ├────────────────────►│                     │
        │                     │                     │
        │                     │ ユーザーアカウント作成   │
        │                     ├─┐                   │
        │                     │ │                   │
        │                     │◄┘                   │
        │                     │                     │
        │                     │ カスタムクレーム設定    │
        │                     ├─┐ (role情報)         │
        │                     │ │                   │
        │                     │◄┘                   │
        │                     │                     │
        │                     │                     │ Userドキュメント作成
        │                     │                     ├─┐
        │                     │                     │ │
        │                     │                     │◄┘
        │                     │                     │
        │ 作成完了レスポンス     │                     │
        │◄────────────────────┴─────────────────────┘
```

**処理ステップ**:
1. SuperAdmin が管理画面からユーザー作成フォームを送信
2. サーバーが Firebase Authentication API を呼び出し、新規ユーザーを作成
3. サーバーが Firebase カスタムクレームに権限情報（role）を設定
4. サーバーが MongoDB の User コレクションに詳細情報を保存
   - ユーザー基本情報（メール、表示名など）
   - 権限情報（role: SuperAdmin, Admin, User）
   - プラン情報（plan: elite, lite）
   - チーム・組織情報（必要な場合）
5. 完了レスポンスを返す

### 1.2 Admin によるユーザー作成フロー（チームメンバー追加）

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│     Admin      │    │    Firebase    │    │    MongoDB     │
│  管理者画面     │    │  Authentication │    │   データベース   │
└───────┬────────┘    └───────┬────────┘    └───────┬────────┘
        │                     │                     │
        │ ユーザー作成リクエスト  │                     │
        ├────────────────────►│                     │
        │                     │                     │
        │                     │ ユーザーアカウント作成   │
        │                     ├─┐                   │
        │                     │ │                   │
        │                     │◄┘                   │
        │                     │                     │
        │                     │ カスタムクレーム設定    │
        │                     ├─┐ (role=USER固定)    │
        │                     │ │                   │
        │                     │◄┘                   │
        │                     │                     │
        │                     │                     │ Userドキュメント作成
        │                     │                     ├─┐ (Admin自身のチームに紐付け)
        │                     │                     │ │
        │                     │                     │◄┘
        │                     │                     │
        │ 作成完了レスポンス     │                     │
        │◄────────────────────┴─────────────────────┘
```

**処理ステップ**:
1. Admin が管理画面からチームメンバー追加フォームを送信
2. サーバーが Firebase Authentication API を呼び出し、新規ユーザーを作成
3. サーバーが Firebase カスタムクレームに権限情報（role=USER固定）を設定
4. サーバーが MongoDB の User コレクションに詳細情報を保存
   - ユーザー基本情報
   - 権限情報（role: USER固定）
   - プラン情報（plan: lite固定）
   - Admin自身のチーム情報で紐付け
5. 完了レスポンスを返す

### 1.3 ユーザー権限・プラン変更フロー

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│   SuperAdmin   │    │    Firebase    │    │    MongoDB     │
│  管理者画面     │    │  Authentication │    │   データベース   │
└───────┬────────┘    └───────┬────────┘    └───────┬────────┘
        │                     │                     │
        │ 権限/プラン変更リクエスト │                   │
        ├─────────────────────┼────────────────────►│
        │                     │                     │
        │                     │                     │ Userドキュメント更新
        │                     │                     ├─┐
        │                     │                     │ │
        │                     │                     │◄┘
        │                     │                     │
        │                     │ カスタムクレーム更新    │
        │                     ├─┐ (権限変更の場合)     │
        │                     │ │                   │
        │                     │◄┘                   │
        │                     │                     │
        │ 更新完了レスポンス     │                     │
        │◄────────────────────┴─────────────────────┘
```

**処理ステップ**:
1. SuperAdmin が管理画面から権限/プラン変更フォームを送信
2. サーバーが MongoDB の User ドキュメントを更新
3. 権限変更の場合、Firebase のカスタムクレームも更新
4. 完了レスポンスを返す

## 2. 運勢更新フロー

### 2.1 運勢更新スケジュール実行フロー

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│    Cronジョブ   │    │     運勢更新    │    │    MongoDB     │
│ (自動スケジューラ) │    │   処理モジュール  │    │   データベース   │
└───────┬────────┘    └───────┬────────┘    └───────┬────────┘
        │                     │                     │
        │ 実行開始（設定時間）   │                     │
        ├────────────────────►│                     │
        │                     │                     │
        │                     │                     │ DailyFortuneUpdateLog作成
        │                     │                     │ (status=scheduled)
        │                     │                     ├─┐
        │                     │                     │ │
        │                     │                     │◄┘
        │                     │                     │
        │                     │ 日柱データ生成・取得    │
        │                     ├────────────────────►│
        │                     │                     ├─┐
        │                     │                     │ │
        │                     │◄────────────────────┘ │
        │                     │                       │
        │                     │                       │
        │                     │ ユーザーリスト取得      │
        │                     ├────────────────────►│
        │                     │                     ├─┐
        │                     │◄────────────────────┘ │
        │                     │                       │
        │                     │ ユーザーごとに運勢生成   │
        │                     ├─┐                    │
        │                     │ │                    │
        │                     │◄┘                    │
        │                     │                      │
        │                     │                      │ DailyFortune複数作成
        │                     │                      ├─┐
        │                     │                      │ │
        │                     │                      │◄┘
        │                     │                      │
        │                     │                      │ DailyFortuneUpdateLog更新
        │                     │                      │ (status=completed)
        │                     │                      ├─┐
        │                     │                      │ │
        │                     │                      │◄┘
        │                     │                      │
        │ 実行完了             │                      │
        │◄────────────────────┴──────────────────────┘
```

**処理ステップ**:
1. Cronジョブが設定時間（デフォルト: 03:00）に運勢更新処理を開始
2. 運勢更新ログを作成（status: scheduled）
3. 現在日付の日柱データを生成または取得
4. 全アクティブユーザーのリストを取得
5. 各ユーザーに対して:
   - 四柱推命プロフィールを読み込み
   - 日柱との相性から運勢スコアを計算
   - 運勢アドバイスを生成
   - ラッキーアイテムを生成
   - DailyFortuneドキュメントを作成
6. 運勢更新ログを更新（status: completed）

### 2.2 運勢更新手動実行フロー

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│   SuperAdmin   │    │     運勢更新    │    │    MongoDB     │
│  管理者画面     │    │   処理モジュール  │    │   データベース   │
└───────┬────────┘    └───────┬────────┘    └───────┬────────┘
        │                     │                     │
        │ 手動実行リクエスト    │                     │
        ├────────────────────►│                     │
        │                     │                     │
        │                     │                     │ DailyFortuneUpdateLog作成
        │                     │                     │ (status=running)
        │                     │                     ├─┐
        │                     │                     │ │
        │                     │                     │◄┘
        │                     │                     │
        │ 開始確認レスポンス    │                     │
        │◄────────────────────┘                     │
        │                     │                     │
        │                     │ （以降は自動実行と同様）  │
        │                     ├─────────────────────┤
        │                     │                     │
```

**処理ステップ**:
1. SuperAdmin が管理画面から手動実行ボタンをクリック
2. サーバーが運勢更新ログを作成（status: running, isAutomaticRetry: false）
3. 実行開始確認レスポンスを即時返す（非同期処理）
4. バックグラウンドで運勢更新処理を実行（自動実行と同様のステップ）

### 2.3 運勢更新監視・リトライフロー

```
┌────────────────┐    ┌────────────────┐    ┌────────────────┐
│    Cronジョブ   │    │     運勢監視    │    │    MongoDB     │
│   (監視用)     │    │   処理モジュール  │    │   データベース   │
└───────┬────────┘    └───────┬────────┘    └───────┬────────┘
        │                     │                     │
        │ 定期チェック実行     │                     │
        ├────────────────────►│                     │
        │                     │                     │
        │                     │ 未完了ログ検索        │
        │                     ├────────────────────►│
        │                     │                     ├─┐
        │                     │◄────────────────────┘ │
        │                     │                       │
        │                     │ 異常ログ発見時          │
        │                     ├─┐                    │
        │                     │ │                    │
        │                     │◄┘                    │
        │                     │                      │
        │                     │ リトライ実行           │
        │                     ├──────────────────────┤
        │                     │  (isAutomaticRetry=true) │
        │                     │                      │
```

**処理ステップ**:
1. 監視用Cronジョブが定期的に（例: 10分ごと）運勢更新ログをチェック
2. 直近24時間内で失敗または未完了のログを検索
3. 該当するログがある場合:
   - リトライカウントが上限未満かチェック
   - 新しい運勢更新ログを作成（isAutomaticRetry: true）
   - 運勢更新処理を実行

## 3. システム設計のポイント

### 3.1 データの整合性

- **Firebase と MongoDB の同期**:
  - ユーザー作成・更新時は必ず両方のシステムを更新する
  - トランザクション失敗時の復旧メカニズムを実装する
  - Firebase のカスタムクレームに権限情報を常に同期する

- **運勢更新の冪等性**:
  - 同じ日の同じユーザーの運勢を複数回更新しても問題ないよう設計する
  - 重複更新検出メカニズムを実装する

### 3.2 エラー処理とリカバリー

- **ユーザー作成失敗時**:
  - Firebase 作成成功 → MongoDB 作成失敗の場合のロールバック
  - 詳細なエラーログの記録と管理者への通知

- **運勢更新失敗時**:
  - 失敗したユーザーIDとエラー詳細の記録
  - 自動リトライによる復旧
  - 部分的成功の場合、成功したユーザーはスキップして残りのみリトライ

### 3.3 セキュリティ考慮事項

- **権限管理**:
  - SuperAdmin のみがユーザー権限を変更可能
  - Admin は自分のチームメンバー（User）のみ管理可能
  - 権限昇格時の厳格な検証

- **監査ログ**:
  - すべての管理操作を AuditLog に記録
  - 誰が、いつ、何を行ったかの追跡可能性を確保