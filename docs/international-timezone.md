# 国際タイムゾーン対応機能 - 実装ガイド

## 概要

国際タイムゾーン対応機能は、世界各国の出生地に対応した正確な四柱推命計算を提供します。この機能により、特定の地域だけでなく、世界中のあらゆる場所での出生データに基づいた精密な四柱推命プロフィールが作成可能になります。

## 主要機能

1. **世界各国のタイムゾーン対応**
   - IANAタイムゾーンデータベースに基づく正確なタイムゾーン計算
   - 政治的タイムゾーンと経度ベースの補正を組み合わせた2段階の時差調整
   - 現代および歴史的なサマータイム（夏時間）規則への対応

2. **出生地情報の強化**
   - 都市名、国名、座標、タイムゾーン識別子を含む拡張ロケーション情報
   - 国際都市データベースによる都市情報の検索と表示
   - 秒単位の精度での時差計算

3. **ユーザーインターフェース**
   - 国際対応モードの切り替え機能
   - 国と都市の選択コンポーネント
   - タイムゾーン情報の表示と選択インターフェース

## 技術実装の詳細

### バックエンド実装

1. **コアモジュール**
   - `TimeZoneUtils.ts`: タイムゾーン計算のユーティリティ関数
   - `SecondAdjuster.ts`: 秒単位の精度調整機能
   - `TimeZoneDatabase.ts`: 世界都市データベース
   - `DateTimeProcessor.ts`: 国際対応版日時処理クラス

2. **APIエンドポイント**
   - `GET /api/v1/day-pillars/timezone-info`: タイムゾーン情報の取得
   - `GET /api/v1/day-pillars/available-cities`: 利用可能な都市リストの取得

3. **データモデル拡張**
   - `ExtendedLocation`: 拡張ロケーション情報インターフェース
   - `TimezoneAdjustmentInfo`: タイムゾーン調整情報インターフェース
   - `User`: モデルに国際対応フィールドを追加

### フロントエンド実装

1. **国際対応コンポーネント**
   - `TimezoneSelector.tsx`: タイムゾーン選択コンポーネント
   - `InternationalLocationForm.tsx`: 拡張ロケーション情報入力フォーム

2. **既存コンポーネントの拡張**
   - `SajuProfileForm.tsx`: 国際対応モード切り替え機能の追加
   - 出生地情報の入力フォームの強化

3. **サービス層の強化**
   - `day-pillar.service.ts`: タイムゾーン情報取得機能の追加
   - `saju-profile.service.ts`: 国際対応プロフィール情報の処理

## 使用方法

### 通常モード

デフォルトでは従来の出生地入力方式が使用されます：

1. 出生地の都市名を入力または選択
2. 座標情報が自動取得され、地方時調整が計算されます
3. 経度ベースの時差計算のみが適用されます

### 国際対応モード

「国際タイムゾーン対応モード」スイッチをオンにすると、以下の機能が有効になります：

1. 国と都市の選択が可能に
2. タイムゾーン情報を手動で指定可能
3. 政治的タイムゾーンと経度ベースの両方の調整が適用
4. サマータイムルールが自動的に適用される
5. 座標情報を手動で調整可能（詳細設定）

## 将来の展望

1. **機能強化**
   - より詳細な世界都市データベースの拡充
   - 歴史的タイムゾーン変更の拡張データ
   - 座標からの自動都市検出機能の精度向上

2. **ユーザー体験の向上**
   - 地図ベースの出生地選択インターフェース
   - 複数の出生地バージョンの比較機能
   - タイムゾーン調整の可視化ツール

## 技術仕様

- **言語**: TypeScript
- **主要ライブラリ**: date-fns-tz, Luxon
- **データソース**: IANA/Olsonタイムゾーンデータベース
- **インターフェース**: Material-UI (MUI)
- **データ精度**: 秒単位までの高精度計算

## 関連リソース

- [国際タイムゾーンリファクタリング計画](./international-timezone-refactoring-plan.md)
- [サジュエンジンパッケージドキュメント](../sajuengine_package/README.md)
- [IANA/Olsonタイムゾーンデータベース](https://www.iana.org/time-zones)