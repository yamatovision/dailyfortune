# 五行バランス・用神情報を活用したラッキーアイテム生成の強化

## 概要

本ドキュメントでは、運勢計算で得られた詳細情報（五行バランス状態・用神関係）をラッキーアイテム生成に統合する実装について説明します。この実装により、ユーザーの命式（四柱）と日々の運勢状態を総合的に考慮した、よりパーソナライズされたラッキーアイテム提案が可能になります。

## 背景と目的

従来のラッキーアイテム生成は、ユーザーの五行属性と日柱の基本的な相性のみを考慮していましたが、より深い四柱推命の知識を活用することで、以下の点を改善することを目指しました：

1. **五行バランスの考慮**: ユーザーの命式における五行バランス（過剰/均衡/不足）を反映
2. **用神との関係性**: 日柱と用神の関係（用神/喜神/忌神/仇神）を反映
3. **相生相剋関係**: 日柱が用神を生成/抑制する関係性を考慮

## 実装アプローチ

### 1. 運勢スコア計算結果の拡張

従来は単なる数値（0-100）だった運勢スコアを、詳細情報を含む`FortuneScoreResult`オブジェクトに拡張しました：

```typescript
interface FortuneScoreResult {
  score: number; // 最終スコア（0-100）
  balanceStatus?: Record<string, 'deficient' | 'balanced' | 'excessive'>; // 五行バランス状態
  yojinRelation?: string; // 用神との関係性
  stemElement: string; // 天干の五行
  branchElement: string; // 地支の五行
  dayIsGeneratingYojin?: boolean; // 日柱が用神を生成する関係性か
  dayIsControllingYojin?: boolean; // 日柱が用神を抑制する関係性か
  useBalancedAlgorithm: boolean; // バランスアルゴリズムを使用したか
  useEnhancedAlgorithm: boolean; // 拡張アルゴリズムを使用したか
  fortuneType?: string; // 運勢タイプ（excellent/good/neutral/poor/bad）
}
```

### 2. データフロー

![データフロー図](../assets/lucky-items-data-flow.png)

1. `calculateFortuneScore` 関数で運勢スコアと共に五行バランス・用神情報を計算
2. `generateFortune` 関数で運勢スコア結果を `generateLuckyItems` 関数に渡す
3. `generateLuckyItems` 関数で Claude AI を使用する場合、運勢スコア詳細情報をプロンプトに含める

### 3. Claude AI プロンプトの強化

プロンプトに含める情報を拡張し、より洞察に富んだラッキーアイテム提案を可能にしました：

- **五行バランス状態**: 各五行が「不足」「均衡」「過剰」のいずれであるかを示す
- **用神関係**: 日柱と用神の関係（「用神」「喜神」「忌神」「仇神」「中性」）
- **相生相剋関係**: 日柱が用神を生成するか抑制するかの情報

プロンプト例：
```
【五行バランス状態】
wood: 不足
fire: 均衡
earth: 均衡
metal: 過剰
water: 不足

【用神との関係】
日柱と用神の関係: 喜神
日柱は用神を生成します。
```

## 実装上の意図とアルゴリズム

### 1. 五行バランスに基づく提案

五行バランスに基づいたラッキーアイテム提案のロジック：

- **不足している五行**: その五行に関連するアイテムを積極的に提案して補う
  - 例: 「木」が不足 → 緑色の衣類、植物由来の食品、ハーブティーなど
- **過剰な五行**: その五行に関連するアイテムは控えめに
  - 例: 「金」が過剰 → 白色や金属系の小物は控え、他の五行をバランス良く

### 2. 用神関係に基づく提案

用神との関係性に基づいたラッキーアイテム提案のロジック：

- **用神・喜神との一致**: 用神・喜神と同じ五行のアイテムを優先
  - 例: 用神が「火」→ 赤色の衣類、温かい食べ物、スパイシーな料理
- **忌神・仇神との一致**: 忌神・仇神と同じ五行のアイテムは避ける
  - 例: 忌神が「水」→ 青や黒の衣類は避け、温かく乾燥した環境を好む

### 3. 相生相剋関係の活用

五行の相生相剋関係を活用したラッキーアイテム提案のロジック：

- **相生関係（生じる）**: 日柱が用神を生じる場合、その相生関係を強化するアイテム
  - 例: 木→火の相生 → 木の要素で火を強化する小物や環境
- **相剋関係（抑制）**: 日柱が用神を抑制する場合、その相剋を和らげるアイテム
  - 例: 金→木の相剋 → 金と木の間の調和を保つアイテム（土の要素）

## 期待される効果

1. **個人化の向上**: 命式の深い理解に基づくパーソナライズされた提案
2. **バランス調整**: 五行バランスの偏りを調整するアイテム提案
3. **用神強化**: 用神・喜神を強化し、忌神・仇神を避けるアイテム提案
4. **日々の変化**: 日柱との関係性を考慮した日々変化する提案

## 運用上の注意点

1. **キャッシュ戦略**: Claude API呼び出しを最適化するため、計算結果を日次でキャッシュ
2. **フォールバック機構**: API障害時は従来の五行テンプレート方式にフォールバック
3. **プロンプト最適化**: ラッキーアイテム生成のプロンプトは定期的に最適化

## 今後の展望

1. **フィードバックの収集**: ユーザーの満足度や実用性に関するフィードバックの収集
2. **季節要素の追加**: 季節や月柱情報を考慮したラッキーアイテム提案
3. **他機能との連携**: 運勢アドバイスやチームコンテキスト運勢との連携強化

## まとめ

五行バランス・用神情報を活用したラッキーアイテム生成の強化により、より深い四柱推命の理論に基づいたパーソナライズされた提案が可能になりました。これにより、ユーザーは自分の命式と日々の運勢に調和したアイテムを選択しやすくなり、より良い一日を過ごすためのサポートとなることが期待されます。