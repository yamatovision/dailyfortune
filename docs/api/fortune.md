# 運勢API

## 概要

運勢API（Fortune API）は、ユーザーの四柱推命プロフィールと日柱データに基づいた日々の運勢情報を提供するエンドポイントを提供します。運勢情報にはスコア、アドバイス、ラッキーアイテムなどが含まれます。

## ベースパス

```
/api/v1/fortune
```

## エンドポイント

### 今日の運勢取得

ログインユーザーの今日の運勢情報を取得します。

**URL:** `GET /api/v1/fortune/daily`

**認証:** 必須（Bearerトークン）

**リクエストヘッダー:**
```
Authorization: Bearer {Firebase IDトークン}
```

**成功レスポンス:**
- コード: 200 OK
- 内容:
```json
{
  "id": "60d5e49bc60d1f001f5e3b1a",
  "userId": "user123",
  "date": "2025-04-08",
  "dayPillar": {
    "heavenlyStem": "壬",
    "earthlyBranch": "午"
  },
  "score": 82,
  "advice": "# 今日のあなたの運気\n\n今日は水の気が強く、創造性と柔軟性が高まる一日です。特に直感力が冴えるため、アイデアを形にする作業に適しています。午前中は冷静な判断力が働き、重要な決断にも迷いが少ないでしょう。午後からは人間関係の調整能力が増し、コミュニケーションがスムーズになります。\n\n感情の起伏はありますが、それを創造的なエネルギーに変換できれば、普段は思いつかないような発想が生まれるでしょう。\n\n# 個人目標へのアドバイス\n\nプログラミングスキル向上という目標に対して、今日は特に新しい技術やライブラリの探索に適しています。チュートリアルを試してみると、直感的な理解が進むでしょう。\n\n「水」の気質を活かして、情報の流れに身を任せ、様々なリソースから吸収する姿勢が効果的です。特に午後2時から4時は学習効率が高まる時間帯なので、集中的に取り組むことをお勧めします。\n\n# チーム目標へのアドバイス\n\nプロジェクト完成に向けて、今日はチームメンバーとのアイデア共有が特に効果的です。特に鈴木さん（火の気質）と協力すると、水火の相乗効果が期待できます。\n\n具体的な数値目標よりも、柔軟なアプローチで全体の流れを整えることを意識しましょう。チームメンバーの意見に耳を傾け、それを統合する役割を担うと、プロジェクトが大きく前進するでしょう。",
  "luckyItems": {
    "color": "ブルー",
    "item": "青いペン",
    "drink": "クリアな水"
  },
  "createdAt": "2025-04-08T00:00:00.000Z",
  "updatedAt": "2025-04-08T00:00:00.000Z"
}
```

**エラーレスポンス:**
- コード: 401 Unauthorized
  - 内容: `{ "error": "認証されていません" }`
- コード: 404 Not Found
  - 内容: `{ "error": "本日の運勢データが見つかりません" }`
- コード: 500 Internal Server Error
  - 内容: `{ "error": "サーバーエラーが発生しました" }`

### 特定日の運勢取得

ログインユーザーの指定された日付の運勢情報を取得します。

**URL:** `GET /api/v1/fortune/daily?date={date}`

**認証:** 必須（Bearerトークン）

**リクエストヘッダー:**
```
Authorization: Bearer {Firebase IDトークン}
```

**クエリパラメータ:**
- `date`: 取得したい日付（YYYY-MM-DD形式）

**成功レスポンス:**
- コード: 200 OK
- 内容: 上記と同じ形式で、指定日付の運勢データが返ります

**エラーレスポンス:**
- コード: 400 Bad Request
  - 内容: `{ "error": "無効な日付フォーマットです" }`
- コード: 401 Unauthorized
  - 内容: `{ "error": "認証されていません" }`
- コード: 404 Not Found
  - 内容: `{ "error": "指定された日付の運勢データが見つかりません" }`
- コード: 500 Internal Server Error
  - 内容: `{ "error": "サーバーエラーが発生しました" }`

### 運勢更新バッチ処理実行（管理者用）

全ユーザーの運勢情報を手動で更新するバッチ処理を開始します。

**URL:** `POST /api/v1/fortune/update-all`

**認証:** 必須（Bearerトークン）

**リクエストヘッダー:**
```
Authorization: Bearer {Firebase IDトークン}
```

**成功レスポンス:**
- コード: 202 Accepted
- 内容:
```json
{
  "status": "processing",
  "message": "運勢更新処理を開始しました",
  "jobId": "job123456",
  "startTime": "2025-04-08T10:30:00.000Z"
}
```

**エラーレスポンス:**
- コード: 401 Unauthorized
  - 内容: `{ "error": "認証されていません" }`
- コード: 403 Forbidden
  - 内容: `{ "error": "この操作にはスーパー管理者権限が必要です" }`
- コード: 409 Conflict
  - 内容: `{ "error": "すでに更新処理が実行中です" }`
- コード: 500 Internal Server Error
  - 内容: `{ "error": "サーバーエラーが発生しました" }`

## データモデル

### Fortune（運勢）

```json
{
  "id": "60d5e49bc60d1f001f5e3b1a",
  "userId": "user123",
  "date": "2025-04-08",
  "dayPillar": {
    "heavenlyStem": "壬",
    "earthlyBranch": "午"
  },
  "score": 82,
  "advice": "マークダウン形式のアドバイスコンテンツ",
  "luckyItems": {
    "color": "ブルー",
    "item": "青いペン",
    "drink": "クリアな水"
  },
  "createdAt": "2025-04-08T00:00:00.000Z",
  "updatedAt": "2025-04-08T00:00:00.000Z"
}
```

- `id`: 運勢データのユニークID
- `userId`: ユーザーID
- `date`: 運勢の日付（YYYY-MM-DD形式）
- `dayPillar`: その日の日柱情報
  - `heavenlyStem`: 天干（十干の一つ）
  - `earthlyBranch`: 地支（十二支の一つ）
- `score`: 運勢スコア（0-100の範囲）
- `advice`: マークダウン形式の運勢アドバイス
  - 「今日のあなたの運気」「個人目標へのアドバイス」「チーム目標へのアドバイス」などが含まれる
- `luckyItems`: ラッキーアイテム情報
  - `color`: ラッキーカラー
  - `item`: ラッキーアイテム
  - `drink`: ラッキードリンク
- `createdAt`: 作成日時
- `updatedAt`: 更新日時

## 実装ノート

運勢APIの実装においては以下の点に注意してください：

1. **運勢計算ロジック**:
   - ユーザーの四柱推命プロフィール（五行属性）と当日の日柱との相性に基づいて計算
   - 五行相生・相克の関係を活用した独自のアルゴリズムでスコアを算出
   - 個人の五行バランスと日柱の属性の相性度合いがスコアに反映

2. **AI連携**:
   - アドバイスコンテンツはユーザー情報、日柱情報、個人/チーム目標を入力としてClaudeAIにより生成
   - 生成コンテンツはマークダウン形式で、セクション分けされた構造的な内容になる
   - ラッキーアイテムは五行属性と相性の良い色や物を選定アルゴリズムで決定

3. **バッチ処理**:
   - 毎日のバッチ処理（午前3時実行）で全ユーザーの当日の運勢を事前に計算
   - 処理結果はDailyFortuneUpdateLogモデルに記録され、管理画面から確認可能
   - 失敗したケースは自動的に再試行される仕組みあり

4. **キャッシュ戦略**:
   - 運勢データは日付ごとに固定されるため、取得結果をキャッシュして処理効率を向上
   - ユーザー情報が更新された場合は、必要に応じて運勢データも再計算