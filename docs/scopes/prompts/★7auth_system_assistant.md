# JWT自社実装認証システム構築アシスタント

## 概要

このプロンプトは、シンプルなJWT自社実装による認証・認可システムを構築するためのガイドです。フロントエンドとバックエンドの両方を含み、シンプルでエラーが起こりにくい実装を目指します。モックアップとAPI仕様に基づいた設計・実装アプローチを採用します。

## 認証基盤の設計原則

### JWT自社実装の特徴
- 外部サービスに依存しない独自JWTベースの認証
- アクセストークンとリフレッシュトークンの2段階方式
- シンプルなトークン管理（署名、有効期限、リフレッシュ）

### 中央管理された認証フロー
- 単一の認証コンテキストで全アプリの認証状態を管理
- 認証ロジックを1箇所に集約し、重複実装を防止
- HTTPOnly Cookieによるセキュアなトークン保存

### ルート保護と権限管理
- 保護ルートコンポーネントによる一元的なルート保護
- 認証ミドルウェアによるバックエンドルートの保護
- ロールベースのアクセス制御（ユーザー/管理者/スーパー管理者）

## 実装ステップ

### 1. ファイル調査と分析

1. **確認すべきファイルとモックアップ分析**
   - **モックアップ分析**
     - `mockups/**.html` - ログインページ、登録ページのモックアップ
   - **既存API仕様の確認**
     - `docs/api/auth.md` - 既存の認証API仕様(あれば)
     - `docs/api/index.md` - API共通設定
   - **データモデル確認**
     - `shared/index.ts` - 共有型定義
     - `server/src/models/User.ts` - ユーザーモデル定義 (存在する場合)
   - **既存環境変数**
     - `.env` または `.env.example` - JWT秘密鍵などの設定

   - **データモデル分析** → `docs/data_models/**.md`(あれば)
     - JWTトークンの構造
     - ユーザーモデルと権限設計
     - リフレッシュトークンの保存方法
   - **UI設計と状態管理** → `docs/ui/**.md`(あれば)
     - JWTトークン管理カスタムフック
     - 認証コンテキスト設計
     - ログイン/ログアウトフロー
     - 保護ルートコンポーネント
   - **実装ガイド** → `docs/implementation/**.md`(あれば)
     - JWTサービス実装手順
     - バックエンド認証ミドルウェア
     - フロントエンド認証フロー
     - 管理者アカウント作成スクリプト
     - テスト用トークン取得スクリプト
     - セキュリティベストプラクティス
   - **環境変数設定** → `.env` (追加)
     ```
     # JWT設定
     JWT_SECRET=*未設定*
     JWT_ACCESS_EXPIRES=3600 # 1時間(秒)
     JWT_REFRESH_EXPIRES=2592000 # 30日(秒)
     
     # 認証セキュリティ設定
     AUTH_RATE_LIMIT=10 # 10リクエスト/分
     PASSWORD_SALT_ROUNDS=12 # bcryptソルトラウンド
     ```

3. **設計原則**
   - シンプルさと実用性を重視する
   - 実装者が迷わずに進められるよう明確なガイドラインを提供
   - モックアップを分析して適切なデータフロー、コンポーネント構造、状態管理戦略を設計

### 2. バックエンド実装

1. **JWTサービス実装**
   - 環境変数による適切なJWTシークレット設定
   - トークン生成・検証関数の実装
   - アクセストークンとリフレッシュトークンの発行ロジック
   - 適切なトークン有効期限設定

2. **認証コントローラー実装**
   - ログイン・登録・トークンリフレッシュの各エンドポイント
   - パスワードハッシュ化と検証機能
   - ユーザー情報の取得エンドポイント

3. **認証ミドルウェア実装**
   - トークン検証と権限チェック
   - エラーレスポンスの統一化
   - 適切なHTTPステータスコード設定

4. **APIルート定義**
   - 認証関連ルートの定義と保護
   - 権限レベルによるルート制限

### 3. バックエンドテスト

1. **依存関係の確認**
   - 必要なパッケージのインストール確認
   - TypeScriptエラーのチェック
   - モジュール解決とパスの問題修正

2. **単体テストの実施**
   - JWTサービスのテスト
   - 認証コントローラーのテスト
   - ミドルウェアのテスト

3. **統合テストの実施**
   - エンドツーエンドの認証フローテスト
   - エラーケースのテスト
   - パフォーマンステスト

### 4. フロントエンド実装

1. **認証サービス実装**
   - トークン管理ユーティリティ
   - API通信のためのインターセプター
   - 認証状態の永続化

2. **認証コンテキスト実装**
   - アプリケーション全体の認証状態管理
   - ログイン/ログアウト機能
   - 権限ベースの条件付きレンダリング

3. **認証UI実装**
   - モックアップに基づいたログインフォーム実装
   - 登録フォーム実装
   - パスワードリセットフォーム実装
   - 入力バリデーション

4. **保護ルート実装**
   - 認証状態に基づくルート保護
   - 権限レベルによるアクセス制御
   - 未認証ユーザーのリダイレクト処理

### 5. フロントエンドテスト

1. **依存関係の確認**
   - 必要なパッケージのインストール確認
   - TypeScriptエラーのチェック
   - コンポーネントのprops型と正確性

2. **ユニットテスト**
   - 認証サービスのテスト
   - コンポーネントのテスト
   - 状態管理のテスト

3. **UIテスト**
   - 表示の確認
   - インタラクションのテスト
   - レスポンシブデザインのテスト

### 6. 認証フローのエンドツーエンドテスト

1. **登録フロー**
   - 新規ユーザー登録処理のテスト
   - バリデーションのテスト
   - エラーケースのテスト

2. **ログインフロー**
   - 認証情報の検証
   - トークン発行の確認
   - 認証状態の管理確認

3. **トークンリフレッシュフロー**
   - アクセストークン期限切れの処理
   - リフレッシュトークンによる再認証
   - セッション無効化のテスト

4. **アクセス制御**
   - 保護されたルートへのアクセステスト
   - 権限に基づくコンテンツ表示の確認
   - 未認証時のリダイレクト確認

### 7. 管理者アカウントとテスト

1. **管理者アカウント作成スクリプト**
   - コマンドライン実行可能なスクリプト実装
   - 管理者権限の設定機能
   - データベース直接操作による初期設定

2. **認証トークン取得スクリプト**
   - テスト用トークン生成機能
   - APIテスト用のcURLコマンド例生成
   - 有効期限表示

3. **API動作検証スクリプト**
   - エンドポイント自動テスト
   - 成功/失敗ケースの確認
   - コマンドライン出力の整形

### 8. セキュリティテスト

1. **脆弱性テスト**
   - OWASP Top 10に基づくセキュリティチェック
   - JWT実装の脆弱性チェック
   - クロスサイトスクリプティング(XSS)対策の検証

2. **認証バイパステスト**
   - トークン改ざんのテスト
   - 権限昇格の試行
   - セッション固定攻撃のテスト

3. **入力検証のテスト**
   - 不正な入力データの処理確認
   - SQLインジェクション対策の確認
   - NoSQLインジェクション対策の確認

## 認証システム実装のベストプラクティス

1. **トークン管理**
   - アクセストークンの短い有効期限設定（15-60分）
   - リフレッシュトークンの適切な有効期限設定（1-30日）
   - HTTPOnly Cookie でのトークン保存

2. **パスワードセキュリティ**
   - 強力なハッシュアルゴリズム使用（bcrypt/Argon2）
   - ソルト付きハッシュの実装
   - パスワード強度要件の設定

3. **エラー処理**
   - 詳細なエラー情報の内部ログ記録
   - ユーザー向けの一般的なエラーメッセージ
   - レート制限による総当たり攻撃の防止

4. **監査とログ**
   - 認証イベントの監査ログ記録
   - 不審なアクティビティの検出
   - 定期的なセキュリティレビュー

## 実装チェックリスト

### バックエンド
- [ ] JWT署名検証の実装
- [ ] パスワードハッシュ化の実装
- [ ] 認証ミドルウェアの実装
- [ ] ユーザーロール/権限管理の実装
- [ ] リフレッシュトークンの実装
- [ ] レート制限の実装
- [ ] エラーハンドリングの統一
- [ ] ログアウト機能の実装

### フロントエンド
- [ ] トークン管理の実装
- [ ] 認証コンテキストの実装
- [ ] ログインフォームの実装
- [ ] 登録フォームの実装
- [ ] パスワードリセットフォームの実装
- [ ] 保護ルートの実装
- [ ] 認証状態UIの実装
- [ ] 入力バリデーションの実装

### テスト
- [ ] JWTサービスの単体テスト
- [ ] 認証コントローラーのテスト
- [ ] ミドルウェアのテスト
- [ ] エンドツーエンド認証フローテスト
- [ ] セキュリティテスト
- [ ] エラー処理テスト
- [ ] パフォーマンステスト

### ドキュメント
- [ ] 認証アーキテクチャの文書化
- [ ] API仕様書の更新
- [ ] 認証フローの図解作成
- [ ] セキュリティガイドラインの文書化
- [ ] トラブルシューティングガイドの作成