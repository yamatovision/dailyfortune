# デイリーフォーチュン 運勢スコア計算アルゴリズム

## 概要

デイリーフォーチュンアプリでは、ユーザーの基本五行属性と日柱の五行属性の相性に基づいて、その日の運勢スコア（0-100点）を計算しています。このスコアは運勢タイプの判定やアドバイス内容の調整に使用されています。

## 計算アルゴリズム

運勢スコアの計算は`fortune.service.ts`の`calculateFortuneScore`関数で行われており、以下のプロセスで計算されます：

### 1. 基本情報の取得

```typescript
// 天干と地支の五行要素を取得
const stemElement = this.getStemElement(heavenlyStem);
const branchElement = this.getBranchElement(earthlyBranch);
```

- `heavenlyStem`: 日柱の天干（甲、乙、丙、丁、戊、己、庚、辛、壬、癸）
- `earthlyBranch`: 日柱の地支（子、丑、寅、卯、辰、巳、午、未、申、酉、戌、亥）
- 各天干・地支は対応する五行属性（木、火、土、金、水）に変換されます

### 2. 相性評価

```typescript
// ユーザーの五行属性と天干・地支の相性を計算
const stemCompatibility = this.calculateElementCompatibility(userElement, stemElement);
const branchCompatibility = this.calculateElementCompatibility(userElement, branchElement);
```

五行間の相性は`calculateElementCompatibility`関数で計算され、0-5のスケールで評価されます：

- **5点**: 同じ属性同士（例：木と木）
- **4点**: 相生関係（例：水は木を育てる）
- **3点**: 間接的・中立的な関係
- **2点**: 弱い相克関係（ユーザーが日柱を抑制）
- **1点**: 強い相克関係（日柱がユーザーを抑制）

#### 相生関係（生じさせる関係）

相生関係とは、一方の五行が他方を生じさせる関係です：

1. 水は木を育てる (`water` → `wood`)
2. 木は火を燃やす (`wood` → `fire`)
3. 火は土を作る (`fire` → `earth`)
4. 土は金を生み出す (`earth` → `metal`)
5. 金は水を浄化する (`metal` → `water`)

相生関係にある五行同士は相性が良く、4点と評価されます。

#### 相克関係（抑制する関係）

相克関係とは、一方の五行が他方を抑制する関係です：

1. 木は土から養分を奪う (`wood` → `earth`)
2. 土は水を堰き止める (`earth` → `water`)
3. 水は火を消す (`water` → `fire`)
4. 火は金を溶かす (`fire` → `metal`)
5. 金は木を切る (`metal` → `wood`)

相克関係にある五行同士は相性が低く、抑制する側なら2点、抑制される側なら1点と評価されます。

### 3. 重み付け計算

```typescript
// 天干と地支の相性を重み付けして最終スコアを計算（天干:地支 = 6:4）
const weightedScore = stemCompatibility * 0.6 + branchCompatibility * 0.4;
```

天干（60%）と地支（40%）の相性スコアを重み付けして合算します。天干の影響がより大きいと考えられているためです。

### 4. スケーリング

```typescript
// 0-100の範囲にスケーリング
const preliminaryScore = Math.round(weightedScore * 20 + 50);
return Math.min(Math.round(preliminaryScore * 2 / 3), 100);
```

重み付けスコア（0-5スケール）を0-100スケールに変換します：

1. まず `weightedScore * 20 + 50` で0-5スケールを10-150スケールに変換
2. 次に `preliminaryScore * 2 / 3` で適切なレンジに圧縮
3. 最後に `Math.min(..., 100)` で100を超える値を100に制限

## 運勢タイプの判定

計算された運勢スコアは、以下のように5段階の運勢タイプに分類されます：

- **excellent（絶好調）**: 80-100点
- **good（好調）**: 60-79点
- **neutral（普通）**: 40-59点
- **poor（やや不調）**: 20-39点
- **bad（不調）**: 0-19点

この運勢タイプは、アドバイス生成やUI表示に使用されます。

## 計算例

ユーザーの五行属性が「木」で、日柱が「壬午」（天干：壬＝水、地支：午＝火）の場合：

1. 相性評価：
   - 木と水（壬）の相性：4点（水は木を育てる相生関係）
   - 木と火（午）の相性：4点（木は火を燃やす相生関係）

2. 重み付け計算：
   - `weightedScore = 4 * 0.6 + 4 * 0.4 = 2.4 + 1.6 = 4`

3. スケーリング：
   - `preliminaryScore = 4 * 20 + 50 = 130`
   - `finalScore = Math.min(Math.round(130 * 2 / 3), 100) = Math.min(87, 100) = 87`

4. 運勢タイプ：
   - 87点 → excellent（絶好調）

## 拡張版アルゴリズム

現行の運勢スコア計算は基本的な五行相性のみを考慮していますが、より洗練された計算を行うための拡張版アルゴリズムが実装されています。拡張版は以下の要素を追加で考慮します：

### 1. 十神関係の考慮

日主（日柱の天干）から見た十神関係を考慮します。十神は以下の10種類があります：

| 十神 | 関係 | 五行関係 | 陰陽 | 基本的な性質 |
|------|------|----------|------|------------|
| 比肩 | 同類 | 同じ五行 | 同じ陰陽 | 協力、同志 |
| 劫財 | 同類 | 同じ五行 | 異なる陰陽 | 競争、闘争心 |
| 食神 | 喜神 | 自分が生む五行 | 陽 | 創造性、楽しみ |
| 傷官 | 喜神 | 自分が生む五行 | 陰 | 表現力、芸術性 |
| 偏財 | 喜神 | 自分を生む五行 | 陽 | 意外な収穫 |
| 正財 | 喜神 | 自分を生む五行 | 陰 | 安定した収入 |
| 偏官 | 忌神 | 自分を克する五行 | 陽 | 権力、抑圧 |
| 正官 | 忌神 | 自分を克する五行 | 陰 | 規律、秩序 |
| 偏印 | 忌神 | 自分が克する五行 | 陽 | 学術、知恵 |
| 印綬 | 忌神 | 自分が克する五行 | 陰 | 権威、サポート |

各十神には0-5のスコアが割り当てられており、例えば「食神」は5.0点、「偏官」は2.5点などと評価されます。

### 2. 地支の隠れた天干の影響

地支にはそれぞれ「隠れた天干（蔵干）」が含まれています。例えば「子」には「癸」が隠れています。拡張版アルゴリズムでは、これらの隠れた天干と日主の十神関係も考慮に入れています。

### 3. 格局情報による調整

ユーザーの格局（命式の気質タイプ）情報に基づいて、十神スコアを調整します：

- **身強**（日主が強い）の場合：
  - 財官（偏財、正財、偏官、正官）は喜神とみなされ、スコアが20%増加
  - 印比（偏印、印綬、比肩、劫財）は忌神とみなされ、スコアが20%減少

- **身弱**（日主が弱い）の場合：
  - 印比（偏印、印綬、比肩、劫財）は喜神とみなされ、スコアが20%増加
  - 財官（偏財、正財、偏官、正官）は忌神とみなされ、スコアが20%減少

### 4. 用神情報の活用

ユーザーの用神（命式を整える要素）情報を考慮して、スコアを調整します：

- 今日の五行が用神の五行と一致する場合、スコアが30%増加
- 今日の五行が用神を生じさせる関係の場合、スコアが20%増加

### 5. 最終スコア計算

拡張版アルゴリズムでは、従来の五行相性スコアと十神関係スコアを50:50の比率で組み合わせ、最終的なスコアを算出します。

```typescript
// 複合スコアの計算（五行相性50%、十神関係50%）
const combinedScore = elementCompatibilityScore * 0.5 + tenGodScore * 0.5;

// 0-100スケールへの変換
const rawScore = Math.round(combinedScore * 20);
return Math.max(0, Math.min(rawScore, 100)); // 0-100の範囲に確実に収める
```

## 拡張版アルゴリズムの有効化

拡張版運勢スコア計算アルゴリズムは環境変数`USE_ENHANCED_FORTUNE_ALGORITHM`で制御されています。デフォルトでは無効になっており、従来のアルゴリズムが使用されます。

```
# .envファイルでの設定
USE_ENHANCED_FORTUNE_ALGORITHM=true
```

拡張版を有効にするには、この環境変数を`true`に設定します。拡張版が有効化されると、ユーザーの日主・格局・用神情報が存在する場合に、より個人化された洗練された運勢スコア計算が行われます。これらの情報が存在しない場合は、自動的に従来のアルゴリズムにフォールバックします。

## 移行ガイド

拡張版アルゴリズムへの移行を検討している場合は、以下のステップに従ってください：

1. テスト環境でまず`USE_ENHANCED_FORTUNE_ALGORITHM=true`を設定
2. テストスクリプト(`scripts/test-enhanced-fortune-score.js`)を実行し、結果を確認
3. 各ユーザーに必要なデータ（日主、格局、用神）が揃っているか確認
4. 不足データがある場合は自動補完ロジックを検討するか、従来アルゴリズムの継続使用を検討
5. スコア分布の変化を確認し、UIやアドバイス生成に与える影響を評価
6. 問題なければ本番環境に段階的に展開

## 将来の展望

将来的には、さらに以下の要素を計算に取り入れることが検討されています：

1. **季節や暦の影響**:
   - 二十四節気や季節による五行の強弱変化
   - 例：春は木が強く、金が弱い

2. **月柱・時柱の影響**:
   - 現在の月柱や時柱との関係も考慮
   - 特に時柱は時間帯による運気の変化に関連

3. **フィードバックによる調整**:
   - ユーザーフィードバックに基づく調整係数の最適化
   - 機械学習を用いた個人化されたスコア予測