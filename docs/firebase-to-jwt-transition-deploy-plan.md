# Firebase認証からJWT認証への移行デプロイ計画（フェーズ5）

## 概要

本ドキュメントでは、DailyFortuneアプリケーションにおけるFirebase認証からJWT認証への移行デプロイ計画を詳細に記述します。
フェーズ1〜4が完了し、実環境へのデプロイと移行完了のための最終フェーズを実施します。

## 移行状況の概要

1. **フェーズ1-3（完了）**
   - JWT認証の基盤実装
   - バックエンド認証の拡張
   - フロントエンド対応
   
2. **フェーズ4（完了）**
   - ユーザー移行スクリプトの開発と実行
   - 全ユーザーへのJWT認証情報（リフレッシュトークン）の設定

3. **フェーズ5（本ドキュメント）**
   - 本番環境へのデプロイ
   - ユーザー通知と移行ガイド提供
   - モニタリングと問題対応

## デプロイ計画

### 1. 事前準備（デプロイ前日）

- **最終テスト実施**
  - ハイブリッド認証の完全動作確認
  - Firebase認証ユーザーの自動移行テスト
  - JWT認証のみのユーザーテスト
  
- **バックアップの作成**
  - MongoDB完全バックアップ
  - コードベースのスナップショット保存
  - ロールバック手順の確認

- **環境変数の最終確認**
  - JWT認証用の秘密鍵設定
  - トークン有効期限設定確認
  - 本番環境接続情報確認

### 2. デプロイ実施（深夜帯）

#### 2.1 バックエンドデプロイ

1. **サーバーコード更新**
   ```bash
   # サーバーにSSH接続
   ssh user@server
   
   # コードベース更新
   cd /path/to/dailyfortune
   git pull origin main
   
   # 依存関係更新
   cd server
   npm install
   ```

2. **JWT関連環境変数設定**
   ```bash
   # .env ファイルに追加
   echo "JWT_ACCESS_SECRET=your_secure_access_secret" >> .env
   echo "JWT_REFRESH_SECRET=your_secure_refresh_secret" >> .env
   ```

3. **サーバー再起動**
   ```bash
   pm2 restart dailyfortune-server
   ```

4. **ヘルスチェック実施**
   ```bash
   # サーバーが正常に起動したことを確認
   curl https://api.dailyfortune.example.com/health
   
   # JWT認証エンドポイントの応答確認
   curl https://api.dailyfortune.example.com/api/v1/auth/jwt-status
   ```

#### 2.2 フロントエンドデプロイ

1. **ビルド実施**
   ```bash
   cd client
   npm run build
   ```

2. **静的ファイルのデプロイ**
   ```bash
   # Firebaseホスティングを使用している場合
   firebase deploy --only hosting
   
   # または別の静的ファイルホスティングサービスを使用
   ```

3. **ブラウザでの動作確認**
   - メインページの表示確認
   - ログイン画面の表示確認
   - JWT移行プロンプト表示確認

### 3. 移行後の確認（デプロイ翌日）

- **ユーザーログインのモニタリング**
  - ログイン成功率の監視
  - エラーログの確認
  - リフレッシュトークン更新のチェック

- **システム全体のパフォーマンス監視**
  - レスポンスタイムチェック
  - サーバーリソース使用状況
  - エラー発生率の確認

## ユーザー通知計画

### 1. 移行に関するユーザー通知

**通知内容:**
```
【DailyFortune認証システム更新のお知らせ】

いつもDailyFortuneをご利用いただき、ありがとうございます。
システムの安定性と機能向上のため、認証システムを更新いたしました。

■変更点
- より安全で効率的な認証システムへの移行
- アカウント設定画面の改善

■ユーザー様へのお願い
次回ログイン時に、新しい認証システムへの移行をお願いいたします。
画面の指示に従って簡単に完了できます。

この更新によりサービスの品質が向上し、より良いユーザー体験を提供できるようになります。
ご不明点がございましたら、サポートまでお問い合わせください。
```

### 2. アプリ内ガイダンス

- **JWT移行モーダル表示**
  - ログイン直後に表示
  - メリットの説明
  - パスワード設定のガイド

- **アカウント設定画面での案内**
  - 認証情報更新セクションの追加
  - 移行ステータス表示
  - ヘルプリンクの提供

## モニタリング計画

### 1. 認証関連メトリクス監視

- **ログイン成功率**
  - Firebase認証成功数
  - JWT認証成功数
  - ハイブリッド認証切替数

- **トークン更新メトリクス**
  - リフレッシュトークン更新成功率
  - アクセストークン発行数
  - トークン有効期限切れイベント数

### 2. エラー監視

- **認証エラーログ**
  - 認証失敗理由の分類
  - エラー発生箇所の特定
  - ユーザーごとのエラー発生パターン分析

- **アラート設定**
  - 認証失敗率が10%を超えた場合の通知
  - リフレッシュトークン更新失敗時の通知
  - API応答時間の異常値検出

## 緊急対応計画

### 1. ロールバック手順

```bash
# バックエンドロールバック
cd /path/to/dailyfortune/server
git checkout previous-stable-tag
npm install
pm2 restart dailyfortune-server

# フロントエンドロールバック
cd /path/to/dailyfortune/client
git checkout previous-stable-tag
npm run build
firebase deploy --only hosting
```

### 2. 緊急対応チーム

- **システム管理者**：システム全体の監視と緊急対応判断
- **開発者**：技術的問題の調査と修正
- **サポート担当**：ユーザー問い合わせ対応

## 移行完了基準

以下の条件をすべて満たした時点で移行完了とみなします：

1. 全ユーザーが少なくとも1回はJWT認証でログインに成功している
2. 認証関連のエラー発生率が通常範囲内（1%未満）に安定している
3. 7日間連続でシステム安定稼働が確認できている

## 最終確認チェックリスト

- [ ] MongoDB上のすべてのユーザーにリフレッシュトークンが設定されている
- [ ] バックエンドのすべてのエンドポイントがJWT認証で正常に動作する
- [ ] フロントエンドのJWT認証移行UIが正しく機能する
- [ ] トークン更新プロセスが自動的に実行される
- [ ] ユーザーへの通知が準備完了している
- [ ] モニタリングダッシュボードが設定されている
- [ ] ロールバック手順が検証されている

## まとめ

Firebase認証からJWT認証への移行は、DailyFortuneアプリケーションの信頼性と拡張性を高めるための重要なステップです。本計画書に従いながら、ユーザー体験を中断することなく、スムーズな移行を実現します。

徹底したテストと明確なコミュニケーション、そして綿密なモニタリングにより、移行プロセスのリスクを最小限に抑え、成功を確実なものとします。