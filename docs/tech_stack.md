# DailyFortune 技術スタック

このドキュメントでは、DailyFortuneプロジェクトで採用する技術スタックとその選定理由について説明します。

## 1. フロントエンド

### 主要技術
- **UI ライブラリ**: React 18
- **言語**: TypeScript 5.x（strict modeで使用）
- **スタイリング**: Material UI 5.x + Emotion
- **状態管理**: Jotai（軽量で使いやすい原子ベースの状態管理）
- **API通信**: React Query + Axios
- **ビルドツール**: Vite
- **テスト**: Vitest + React Testing Library
- **フォーム管理**: React Hook Form + Zod

### 選定理由

#### React + TypeScript
- 堅牢な型システムによるバグの早期発見
- 開発者体験の向上と自己文書化コードの実現
- 豊富なエコシステムとコミュニティサポート
- 日本語の情報が豊富で習得障壁が低い

#### Material UI
- 五行に基づいたカラーパレットの容易なカスタマイズ
- モバイルファーストのレスポンシブコンポーネント
- アクセシビリティ対応済みのコンポーネント
- 一貫したデザインシステムの実現

#### Jotai
- ReduxやContext APIよりも軽量でシンプル
- コンポーネント間の状態共有が容易
- リアクティブな状態更新の実現
- 無駄なレンダリングを減らす最適化機能

#### React Query
- サーバー状態と同期するための優れた機能
- キャッシュ管理とバックグラウンド更新
- エラーハンドリングと再試行機能
- ローディング状態の簡潔な管理

#### Vite
- 高速な開発サーバーとHMR（Hot Module Replacement）
- 迅速なビルド時間
- ESモジュールネイティブサポート
- 設定の少なさと使いやすさ

## 2. バックエンド

### 主要技術
- **フレームワーク**: Express.js + TypeScript
- **APIスタイル**: RESTful API
- **バリデーション**: Zod
- **認証**: Firebase Authentication
- **ロギング**: Winston
- **テスト**: Jest
- **ORM**: Mongoose（MongoDB用）

### 選定理由

#### Express.js
- 軽量で柔軟なNode.jsフレームワーク
- 広く採用されており、信頼性が高い
- ミドルウェアアーキテクチャによる拡張性
- TypeScriptとの相性が良い

#### RESTful API
- 明確な構造と予測可能なエンドポイント
- フロントエンドとの統合が容易
- キャッシュ機能の活用が可能
- クライアント-サーバー間の懸念事項の分離

#### Zod
- TypeScriptとのシームレスな統合
- ランタイムバリデーションの型安全性
- エラーメッセージのカスタマイズが容易
- スキーマの合成と再利用が可能

#### Firebase Authentication
- セキュアな認証基盤
- メール/パスワード認証の容易な実装
- 将来的なソーシャルログイン統合の容易さ
- トークンベースの認証フローのシンプルさ

## 3. データベース

### 主要技術
- **データベース**: MongoDB
- **クラウドサービス**: MongoDB Atlas
- **ODM**: Mongoose

### 選定理由

#### MongoDB
- 柔軟なスキーマレスデータモデル
- JSONライクなドキュメント構造
- 複雑なデータ関係の容易な格納
- ネイティブなTypeScript/JavaScript連携

#### MongoDB Atlas
- フルマネージドクラウドサービスによる運用負荷軽減
- 自動スケーリングとバックアップ
- 無料枠からの開始が可能
- 堅牢なセキュリティとモニタリング機能

#### Mongoose
- TypeScriptとの統合によるスキーマ検証
- ミドルウェア機能（保存前のフック等）
- クエリビルダーAPIによる直感的なクエリ作成
- バリデーションとビジネスロジックの統合

## 4. 認証

### 主要技術
- **認証サービス**: Firebase Authentication
- **認証方式**: JWTトークン
- **権限管理**: カスタムクレームとロールベースアクセス制御

### 選定理由

#### Firebase Authentication
- グーグルのインフラによる高いセキュリティ
- 日本語対応の管理コンソール
- 認証関連の複雑な実装を外部化
- モバイルファーストのアプローチ

#### JWTトークン
- ステートレスな認証メカニズム
- スケーラブルなアーキテクチャ
- クライアント側での簡単な保存と使用
- サーバー側での効率的な検証

## 5. 共通基盤

### 主要技術
- **パッケージ管理**: npm
- **コード品質**: ESLint + Prettier
- **CI/CD**: GitHub Actions
- **デプロイ**: Firebase Hosting + Google Cloud Run + MongoDB Atlas
- **ロギング/モニタリング**: Google Cloud Logging + Firebase Performance Monitoring

### 選定理由

#### npm
- JavaScriptエコシステムのデファクトスタンダード
- 広範なパッケージライブラリへのアクセス
- Workspacesによるモノレポ管理
- シンプルで直感的なコマンド体系

#### ESLint + Prettier
- 一貫したコードスタイルの強制
- 潜在的なバグやアンチパターンの検出
- IDEとの統合による即時フィードバック
- チーム開発でのコード品質の均一化

#### Firebase Hosting + Google Cloud Run
- 開発から本番環境までのシームレスな連携
- スケーラブルなサーバーレスアーキテクチャ
- 高速なグローバルCDNによるコンテンツ配信
- 自動化されたCI/CDパイプラインとの統合

## 6. デプロイ構成

### 環境構成
- **開発環境**: ローカル開発 + MongoDB Atlas開発クラスター
- **テスト環境**: Firebase Hosting (Preview Channel) + Cloud Run (dev) + MongoDB Atlas開発クラスター
- **本番環境**: Firebase Hosting + Cloud Run + MongoDB Atlas本番クラスター

### CI/CD パイプライン
GitHub Actionsを使用して以下のワークフローを自動化:

1. コードプッシュ時の自動テスト実行
2. プルリクエストのプレビュー環境へのデプロイ
3. mainブランチへのマージ時に本番環境へ自動デプロイ
4. デプロイ後の自動テスト実行

## 7. 特殊技術要件

### 四柱推命エンジン
- カスタム開発されたSajuEngineパッケージを使用
- TypeScriptで実装され、日本のタイムゾーンに対応
- 外部依存関係を最小限に抑えた軽量設計
- 四柱推命の計算ロジックをカプセル化

### AI機能
- Claude API (Anthropic)を使用したチャット機能
- サーバーサイドでのAPIリクエスト処理
- レート制限とトークン使用量の監視
- コンテキスト情報の適切な提供と管理

### Web Speech API
- ブラウザネイティブの音声認識機能
- モバイルデバイスでの音声入力最適化
- フォールバックメカニズムの実装
- 言語検出と処理の適応

## 8. パフォーマンス最適化

### フロントエンド
- コードスプリッティングとレイジーローディング
- メモ化によるレンダリング最適化
- 画像の最適化とプリロード
- PWA対応による高速な再訪問体験

### バックエンド
- レスポンスのキャッシュ戦略
- データベースインデックスの適切な設定
- 非同期処理とバッチ処理の活用
- クエリの最適化と不要なデータ取得の回避

## 9. セキュリティ対策

- JWT認証とCSRF対策
- 入力バリデーションとサニタイズ
- レート制限による過剰リクエストの防止
- 環境変数による機密情報の保護
- HTTPSの強制とセキュアヘッダーの設定