# 格局（気質タイプ）機能実装サマリー

## 実装概要

四柱推命プロフィールに格局（気質タイプ）機能を実装しました。格局とは、日干を中心に命式全体のバランスから判定される気質タイプで、身強・身弱の判定と特別格局/普通格局の分類により、個人の気質や特性を詳細に理解することができます。

## 実装範囲

1. **SajuEngineパッケージ**
   - 格局計算モジュール (`kakukyokuCalculator.ts`) の実装
   - 四柱推命計算結果に格局情報を追加
   - 身強・身弱の判定ロジックの実装
   - 特別格局・普通格局の判定ロジックの実装

2. **データモデル拡張**
   - `User`モデルに格局情報を保存するフィールドを追加
   - ISajuProfileインターフェースの更新（後方互換性のため）
   - 共有型定義ファイル (`shared/index.ts`) の更新

3. **サーバー側の実装**
   - 四柱推命計算サービスを拡張して格局情報を計算
   - 格局情報に日本語の説明を追加

4. **フロントエンド実装**
   - 格局情報を表示するコンポーネントの実装
   - SajuProfileCardコンポーネントの拡張

## 格局の種類

### 特別格局（極身強・極身弱）

特別格局は命式全体の約15%の人に該当する特殊な気質タイプです。

#### 極身強の特別格局
1. **従旺格**: 主体性があり、自分の思った通りに人生を突き進む
2. **従強格**: 独自の人生観を持ち、学識の充実した人生を歩む

#### 極身弱の特別格局
1. **従児格**: 社交的で頭の回転が速く、鋭い感性と人生観を持つ
2. **従財格**: とても強い財運を持ち、人間関係にも恵まれる
3. **従殺格**: 忍耐強く封建的な世界を好み、目上につき従う
4. **従勢格**: 円満な性格で、環境や状況に柔軟に対応していく

### 普通格局

普通格局は命式全体の約85%の人に該当する一般的な気質タイプです。

1. **建禄格**: 独立心が強く負けず嫌いな性格で、人生を切り拓く
2. **月刃格**: プライドが高く、自分の世界や価値観を重視する
3. **食神格**: 鋭い感覚を持ち快楽主義者で、のびのびと生きる
4. **傷官格**: 独自の感性の持ち主で、専門技術の習得にも長ける
5. **偏財格**: 社交的で義理人情に厚く、物質生活を重んじる
6. **正財格**: 現実的な合理主義者で、堅実な価値判断をする
7. **偏官格**: 正義感にあふれ、強い者を抑えて弱い者を助ける
8. **正官格**: まじめで大言を表さず、規律や礼儀を重んじる
9. **偏印格**: 知的好奇心が旺盛で、内面世界の探求を重視する
10. **印緑格**: 好奇心旺盛で、知識を吸収することに喜びを感じる

## 実装詳細

### 格局計算の流れ

1. 命式の蔵干（地支に内蔵された天干）を求める
2. 命式全体の通変星（十神関係）を計算
3. 身強・身弱の判定
   - 得令（当旺・次旺）
   - 天干と地支の関係性
   - 三方会局・三合会局の形成
4. 特別格局か普通格局かの判定
5. 具体的な格局タイプの特定

### 身強・身弱の判定条件

以下の条件に基づいて、命式全体から日干の強弱（身強・身弱）を判定します：

1. **得令（当旺・次旺）**: 各五行が強まる季節・月の関係
2. **地支の影響**: 日干を強める地支の数
3. **天干の影響**: 日干を強める天干の数
4. **三方会局**: 地支が特定の五行を強める組み合わせの存在
5. **三合会局**: 地支の特殊な組み合わせによる五行の強化
6. **四墓土局**: 土の気を強める地支の組み合わせ（辰・戌・丑・未）

### 格局判定のアルゴリズム

格局判定は、以下の優先順位で行われます：

1. 命式の五行バランスから「極身強」「極身弱」を判定
2. 極端な場合は通変星の分布から特別格局を判定
3. それ以外の場合は月支と日主の関係から普通格局を判定
4. 建禄格・月刃格などの特殊な組み合わせを優先的に判定
5. それ以外は通変星の分布から適切な格局を選定

## 今後の展開

1. **用神機能の実装**
   - 用神（運気を高める五行要素）の計算機能の追加
   - 用神に基づく具体的なアドバイス機能の実装

2. **格局に基づいた運勢アドバイスの強化**
   - 個人の格局タイプに基づいた、より詳細な運勢アドバイスの提供
   - 格局ごとの特性を活かした具体的な行動指針の提案

3. **UI/UX改善**
   - 格局情報の視覚的な表現の洗練
   - 解説コンテンツの充実

## 参考資料

- [四柱推命における格局（気質タイプ）を求めるアルゴリズム](/docs/saju_kakukyoku_algorithm.md)
- [四柱推命における用神の求め方と活用法](/docs/saju_yojin_algorithm.md)
- [格局と用神の実装計画](/docs/kakukyoku_yojin_implementation_plan.md)