# 要件定義書: DailyFortune - 経営者向け人材管理ツール

## 1. プロジェクト概要

DailyFortuneは、四柱推命の原理を活用した経営者向けの人材管理ツールです。ユーザーの生年月日時と場所に基づいた四柱推命の情報と、日々変化する日柱情報を組み合わせて、日々の運勢予報と人材管理のアドバイスを提供します。モバイルファーストの設計で、チーム内のコミュニケーションと理解を深め、経営者が従業員のモチベーションや潜在的な問題を把握するのを支援します。サブスクリプションベースのビジネスモデルを採用し、経営者と従業員別のプランを提供します。

## 2. 目標とゴール

- 経営者と従業員間のコミュニケーションを円滑にする
- チームメンバー間の相性や特性の理解を深める
- 日々の運勢に基づいた業務アドバイスを提供する
- モチベーション低下や離職リスクの早期発見を支援する
- チーム目標達成のための最適な人材配置と戦略を提案する
- 各ユーザーのニーズと予算に合わせた料金プランを提供する

## 3. ターゲットユーザー

- **SuperAdmin**: システム全体の管理者（サイト運営者）
- **Admin**: 経営者/チームリーダー（エリートプラン/Sonnetモデル）
- **一般ユーザー**: チームメンバー/従業員（ライトプラン/Haikuモデル）

※第一フェーズでは、すべてのユーザーはチームに所属することを前提とします。個人プランのみのユーザー（チームなしユーザー）は現時点ではスコープ外とします。

## 4. 機能要件

### 4.1 コア機能（MVP）

1. **ユーザー管理システム**
   - SuperAdmin、Admin、一般ユーザーの3階層の権限管理
   - 組織構造の管理（組織→チーム→ユーザー）
   - ユーザー登録・プロフィール設定（生年月日時、出生地、個人目標）
   - チーム招待機能
   - プラン管理（エリート/ライト）

2. **サブスクリプション管理**
   - 組織単位でのサブスクリプション管理
   - エリートプラン（Admin向け、9,700円/月）とライトプラン（一般ユーザー向け、1,500円/月/ユーザー）
   - 支払い管理と請求書発行
   - Adminによるユーザー数の増減とプラン変更
   - 利用統計とリソース管理

3. **四柱推命エンジン連携**
   - SajuEngineを使用したユーザーの四柱推命情報の計算と保存
   - 毎日の日柱情報に基づく運勢更新（毎日3時に自動更新）
   - 蔵干（隠れた性質）を含む詳細な四柱推命情報の保存

4. **デイリー運勢機能**
   - 今日の運勢表示（詳細説明、運勢得点/100点中）
   - ラッキーアイテム提案
   - 統合されたアドバイス（個人目標・チーム目標を含む）
   - Claude Sonnetモデルによる高品質なコンテンツ生成（プラン関係なく提供）

5. **統合AIチャット機能**
   - 複数の相談モードを1つのシンプルなインターフェースに統合
   - AIアシスタント機能（プランに応じてSonnet/Haikuモデル切替）
   - プラン別の使用制限（ライトプランは1日の相談回数に制限あり）
   - 提供されるコンテキストデータ
     - ユーザーの四柱推命情報（天干地支、蔵干、五行）
     - 今日の運勢データ
     - チームメンバーとの相性情報
     - チーム目標情報
   - 音声入力機能でモバイルデバイスからの利用を最適化
   - 会話履歴の保存・クリア機能
   - 五行の色を活用した視覚的フィードバック

6. **チーム機能**
   - チーム目標設定（Admin用）
   - チームメンバーの役割設定（エンジニア、営業など）
   - チーム内運勢ランキング（メンバーごとの運勢スコア表示）
   - メンバー間の相性表示（五行理論に基づく相性分析）
   - チームメンバー相性マトリックス（全メンバー間の相性をマトリックス形式で一覧表示）
   - チーム相性分析レポート（主な強み、課題、アドバイスを含む）
   - 五行属性（水・木・火・土・金）による特性表示
   - メンバー詳細表示（モーダルウィンドウ）

7. **経営者ダッシュボード（Admin向け）**
   - チームメンバーのモチベーション/離職リスク検知
   - AIチャット履歴からの問題発見支援
   - チーム目標達成のためのアドバイス提供
   - ユーザー管理（ユーザー追加、プラン変更）

8. **システム管理機能（SuperAdmin専用）**
   - 独立した管理サイトとして実装
   - 組織・管理者アカウント管理
   - サブスクリプション管理
   - システム設定（運勢更新時間、API利用量設定）
   - 利用統計（ユーザー統計、AI利用統計）
   - システムメンテナンス（DBバックアップ、キャッシュクリア）

### 4.2 追加機能（将来実装）

1. **複数チーム管理機能**（組織内の複数チーム）
2. **分析レポート機能**
3. **アラート・通知システム**
4. **カスタムダッシュボード**
5. **プラン変更と料金自動調整機能**
6. **個人プラン**（チームに所属しないユーザー向け機能）

## 5. 非機能要件

1. **パフォーマンス**
   - ページ読み込み時間：3秒以内
   - 運勢更新処理：5分以内に全ユーザー更新完了
   - API応答時間：1秒以内

2. **セキュリティ**
   - ユーザー認証・権限管理
   - 個人情報保護対策
   - データ暗号化
   - 支払い情報の安全な管理
   - SuperAdmin管理サイトへのアクセス制限

3. **可用性**
   - システム稼働率99.5%以上
   - 定期バックアップ
   - エラー回復メカニズム

4. **スケーラビリティ**
   - 将来的なユーザー増加に対応できる設計
   - MongoDBの水平スケーリング対応
   - APIリクエスト増加への対応

5. **UI/UX**
   - モバイルファーストデザイン
   - レスポンシブWebデザイン
   - ブランドカラー：紫を基調としつつ五行の色を活用
     - 木：緑 (#43a047)、薄い緑 (#81c784)、濃い緑 (#2e7d32)、背景 (#e8f5e9)
     - 火：赤 (#e53935)、薄い赤 (#ef5350)、濃い赤 (#c62828)、背景 (#ffebee)
     - 土：オレンジ (#ff8f00)、薄いオレンジ (#ffd54f)、濃いオレンジ (#ef6c00)、背景 (#fff8e1)
     - 金：金色 (#fdd835)、薄い金色 (#ffee58)、濃い金色 (#f9a825)、背景 (#fffde7)
     - 水：青 (#1e88e5)、薄い青 (#64b5f6)、濃い青 (#0d47a1)、背景 (#e3f2fd)
   - モダンで洗練されたミニマルデザイン
   - プロフェッショナルな印象のビジュアル要素
   - 五行属性カラーを用いた直感的な相性表示
   - Material Design風のコンポーネントとスタイリング
   - アニメーションと適切なトランジション効果

## 6. システム構成

### 6.1 アプリケーション構成

本システムは以下の2つの独立したアプリケーションで構成されます：

1. **メインアプリケーション**
   - 一般ユーザーとAdmin（経営者）向けの機能を提供
   - モバイルファーストのレスポンシブデザイン
   - 四柱推命計算と運勢表示、チーム管理、AIチャット機能を実装
   - サブスクリプション管理インターフェース（Admin向け）

2. **SuperAdmin管理サイト**
   - システム全体の管理機能を提供する独立したアプリケーション
   - SuperAdmin権限を持つユーザーのみアクセス可能
   - 組織・サブスクリプション管理
   - システム設定、管理者権限管理、利用統計、メンテナンス機能を実装

## 7. ページリスト

### 7.1. メインアプリケーション - 共通ページ

1. **ログインページ**
   - **説明**: システムへのアクセス認証
   - **主要機能**:
     - ユーザー認証
     - パスワードリセット

2. **プロフィール設定ページ**
   - **説明**: ユーザーの個人情報と目標設定
   - **主要機能**:
     - 生年月日時、出生地の入力
     - 複数の個人目標設定（期限付き）
       - キャリア目標（仕事やスキル関連）
       - チーム目標（チーム内の役割や貢献）
       - 個人的な目標（プライベートや自己成長）
     - 四柱推命情報の詳細表示
       - 四柱（年柱、月柱、日柱、時柱）情報
       - 蔵干（隠れた性質）の表示
       - 性格特性に関する詳細解説
       - 仕事とキャリアに関する適性
     - パスワード変更

### 7.2. メインアプリケーション - 一般ユーザー向けページ

3. **ホームページ（デイリー運勢）**
   - **説明**: ユーザーの今日の運勢を表示
   - **主要機能**:
     - 今日の運勢スコア（100点満点）
     - 運勢の詳細説明
     - ラッキーアイテム
     - 統合されたアドバイス
       - 複数の目標の中から、その日の運勢に最も関連性の高い目標を自動選択
       - 期限が近い目標や日柱との相性を考慮して選択
       - 具体的かつ実践的なアドバイスを提供
     - 運勢相談チャットへのリンク

4. **統合AIチャットページ**
   - **説明**: 直感的で使いやすいAIチャットインターフェース
   - **主要機能**:
     - Claude AIとのシームレスなチャット（プランに応じたモデル切替）
     - 統合された単一のシンプルなチャットインターフェース
     - 使用回数表示（ライトプラン向け）
     - 背景コンテキスト情報の自動提供
       - ユーザーの四柱推命情報（天干地支、蔵干、五行）
       - 今日の運勢データ
       - 関連するチームメンバーの情報
       - チーム目標情報
     - 音声入力ボタン（Web Speech API使用）
     - 会話履歴保存・クリア機能
     - 直感的なUI（送信ボタン、音声入力ボタン、設定メニュー）
     - モバイルデバイス最適化設計

5. **チームページ**
   - **説明**: チームメンバーの情報と五行相性
   - **主要機能**:
     - チームメンバーリスト（五行属性表示付き）
     - メンバーの属性と役割の表示
     - 今日の運勢ランキング（五行属性カラー表示）
     - チームメンバー相性マトリックス（マトリックス形式での全メンバー間の相性表示）
       - 相性スコア（0-100%）
       - 関係タイプ（相生・相克・中和）の視覚的表示
       - 色分けによる直感的な相性把握
     - チーム相性分析レポート
       - 主な強みの組み合わせ
       - 主な課題となる組み合わせ
       - チーム全体のバランス分析
       - 協力のためのヒント
     - メンバー詳細モーダル表示
       - 詳細な五行相性分析
       - 相性チャート
       - 相性詳細説明
     - 統合AIチャットへのリンク（選択メンバー情報付き）

### 7.3. メインアプリケーション - Admin向けページ

6. **チーム管理・経営者ダッシュボード**
   - **説明**: チーム管理と経営者向け情報の統合インターフェース
   - **主要機能**:
     - タブ切り替え方式の統合ダッシュボード
       - チーム管理タブ
         - チーム目標の設定・編集（シンプルな入力で目標を記述）
         - メンバー追加・編集機能
         - メンバーテーブル（名前、役割、五行属性、メールアドレス表示）
       - 経営者ダッシュボードタブ
         - チーム概要統計（メンバー数、アラート数、離職リスク）
         - 緊急アラート通知（モチベーション低下、離職リスク）
         - メンバーインサイト（AIチャット分析に基づく管理アプローチ提案）
           - 各メンバーに対する効果的なアプローチ方法
           - 五行相性に基づく最適なコミュニケーション提案
           - その日の気の流れに合わせた面談タイミング提案

7. **サブスクリプション管理ページ**
   - **説明**: プランと請求の管理
   - **主要機能**:
     - 現在のプラン表示
     - ユーザー追加・削除
     - ライト/エリートプラン切り替え
     - 請求情報と支払い履歴
     - 次回請求額の表示

### 7.4. SuperAdmin管理サイト

8. **組織管理ページ**
   - **説明**: システム全体の組織管理
   - **主要機能**:
     - 組織の追加・編集・削除
     - 組織管理者（Admin）の管理
     - 組織詳細情報の表示
     - 組織ごとの統計データ表示

9. **サブスクリプション管理ページ**
   - **説明**: システム全体のサブスクリプション管理
   - **主要機能**:
     - 組織ごとのサブスクリプション管理
     - プラン設定と価格管理
     - 請求状況と支払い履歴
     - 未払い・延滞管理

10. **システム管理ページ**
    - **説明**: システム全体の設定と管理
    - **主要機能**:
      - システム設定（運勢更新時間、API利用量設定）
      - 利用統計（ユーザー統計、AI利用統計）
      - データベースバックアップとキャッシュ削除
      - グラフによる視覚的な統計表示

## 8. データモデル

### 8.1 組織データ
- 組織ID
- 組織名
- SuperAdmin ID
- サブスクリプション情報
- 請求情報
- 作成日時
- 更新日時

### 8.2 サブスクリプションデータ
- サブスクリプションID
- 組織ID
- ステータス（アクティブ/トライアル/期限切れ/キャンセル）
- 期間開始日
- 期間終了日
- 価格プランID
- ユーザー数
- Admin数（エリートプラン）
- 一般ユーザー数（ライトプラン）
- 合計金額
- 通貨
- 支払い方法
- 作成日時
- 更新日時

### 8.3 プラン情報
- プランID
- プラン名（エリート/ライト）
- 価格
- ユーザータイプ（Admin/User）
- 機能制限情報
- 作成日時
- 更新日時

### 8.4 ユーザーデータ
- ユーザーID
- 組織ID
- メールアドレス
- パスワード（ハッシュ）
- 表示名
- 権限レベル（SuperAdmin/Admin/User）
- プラン種別（エリート/ライト）
- 所属チームID（オプション）
- 役割（エンジニア、営業など）
- 四柱推命プロフィールID
- 五行属性（高速アクセス用）
- アクティブ状態
- 作成日時
- 更新日時

### 8.5 SajuProfile（四柱推命プロフィール）
- プロフィールID
- ユーザーID
- 生年月日
- 出生時間
- 出生場所
- 五行属性
- 日主
- 四柱情報
  - 年柱（天干、地支、天干十神、地支十神、蔵干）
  - 月柱（天干、地支、天干十神、地支十神、蔵干）
  - 日柱（天干、地支、天干十神、地支十神、蔵干）
  - 時柱（天干、地支、天干十神、地支十神、蔵干）
- 性格特性説明
- キャリア適性説明
- 作成日時
- 更新日時

### 8.6 個人目標データ
- 目標ID
- ユーザーID
- 目標タイプ（キャリア/チーム/個人）
- 目標内容
- 目標期限
- 作成日時
- 更新日時

### 8.7 チームデータ
- チームID
- 組織ID
- チーム名
- 管理者ID（Admin）
- 作成日時
- 更新日時

### 8.8 チーム目標データ
- 目標ID
- チームID
- 目標内容
- 目標期限
- 作成日時
- 更新日時

### 8.9 日柱データ
- 日柱ID
- 日付
- 天干
- 地支
- 蔵干
- エネルギー説明
- 作成日時

### 8.10 運勢データ
- 運勢ID
- ユーザーID
- 日付
- 日柱ID
- 運勢スコア
- アドバイス（統合）
- ラッキーアイテム
- 作成日時
- 更新日時

### 8.11 相性データ
- 相性ID
- ユーザーID1
- ユーザーID2
- 相性スコア（0-100）
- 関係タイプ（相生/相克/中和）
- ユーザー1の五行属性
- ユーザー2の五行属性
- 相性詳細説明
- 作成日時
- 更新日時

### 8.12 チャットデータ
- チャットID
- ユーザーID
- チャットタイプ（個人/チームメイト/チーム目標）
- 関連情報（チームメイトIDなど）
- AIモデル（sonnet/haiku）
- メッセージ履歴
- コンテキスト情報（JSONデータ）
- 作成日時
- 最終更新日時

### 8.13 請求書データ
- 請求書ID
- 組織ID
- サブスクリプションID
- 請求書番号
- 請求金額
- 通貨
- ステータス（下書き/未払い/支払済み/無効）
- 請求期間開始
- 請求期間終了
- 支払期限
- 支払日
- 作成日時
- 更新日時

### 8.14 統計データ
- 統計ID
- 組織ID
- 統計タイプ（ユーザー/AI）
- 日付
- メトリクス
  - 総ユーザー数
  - アクティブユーザー数
  - 新規ユーザー数
  - AIリクエスト数
  - レスポンス時間
  - Haiku使用回数
  - Sonnet使用回数
- 作成日時

## 9. 技術スタック

### 9.1. メインアプリケーション

- **フロントエンド**
  - モバイルファーストのレスポンシブWebアプリケーション
  - React.js + Material UI
  - Web Speech API（音声入力機能）
  - PWA対応（将来的にアプリ化を視野に）

- **バックエンド**
  - Node.js
  - Express.js
  - MongoDB
  - SajuEngine（四柱推命計算エンジン）
  - Claude AI API (Anthropic)
  - 決済API

### 9.2. SuperAdmin管理サイト

- **フロントエンド**
  - React.js + Material UI / React Admin
  - データ可視化ライブラリ（Chart.js / Recharts）

- **バックエンド**
  - メインアプリケーションと共通のAPIを使用
  - 管理者専用APIエンドポイント

### 9.3. 共通インフラ

- **データベース**
  - MongoDB

- **インフラ**
  - AWS / GCP
  - Docker
  - CI/CD パイプライン

## 10. 制約条件

- モバイル最適化が必須（メインアプリケーション）
- SuperAdmin管理サイトへのアクセスはSuperAdmin権限を持つユーザーのみに制限
- 毎日3時に運勢更新を行う自動化処理
- チャット履歴は永続化するが1スレッドのみ保持
- Claude AI API利用料の予算制約を考慮
  - ライトプラン: 1日あたりの相談回数に制限
  - エリートプラン: 制限なし、Sonnetモデル使用
- 決済システムとの連携（API経由）
  - 支払い失敗時はユーザーログインを制限し、メールで決済案内
- チャット履歴は3種類（個人/チームメイト/チーム目標）のみ保持し、各1スレッドに制限

## 11. マイルストーン

1. **フェーズ1（基盤開発）**: 6週間
   - ユーザー・組織管理システム
   - サブスクリプション基盤
   - SajuEngine連携
   - デイリー運勢基本機能

2. **フェーズ2（主要機能開発）**: 8週間
   - AIチャット機能（Sonnet/Haiku切替）
   - チーム機能
   - 運勢詳細機能
   - 決済連携

3. **フェーズ3（管理機能開発）**: 6週間
   - 経営者ダッシュボード
   - サブスクリプション管理UI
   - データ分析機能
   - SuperAdmin管理サイト開発

4. **フェーズ4（テスト・リリース）**: 4週間
   - ベータテスト
   - フィードバック収集と修正
   - 本番リリース