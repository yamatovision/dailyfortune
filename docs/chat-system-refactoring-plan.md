# チャットシステムリファクタリング計画書

## 概要

現在のClaude AIサービスコードには複数の責務が集中しており、保守性と拡張性に課題があります。本計画では、関心事の分離原則に基づき、機能ごとに独立したサービスモジュールへと段階的にリファクタリングします。

## 現状分析

### 問題点
- `claude-ai.ts`に複数の異なる機能が混在
- プロンプト定義の重複（chat.service.tsとclaude-ai.ts）
- 各機能の境界が曖昧で拡張困難
- テスト容易性の低下

### 主要機能
1. ChatAPI呼び出し（基本API）
2. チャット機能（3種類のモード）
3. デイリーフォーチュン生成
4. ラッキーアイテム生成
5. 調和のコンパス生成
6. チームメンバーカルテ生成

## リファクタリング目標

1. 責務の明確な分離
2. コード重複の排除
3. テスト容易性の向上
4. 拡張性の確保
5. エラー処理の一貫性

## 実装計画

### フェーズ1: API基盤の分離（2日間）

1. **基本APIクライアント層の作成**
   - 新規ファイル: `claude-api-client.ts`
   - 基本機能: 認証、リクエスト送信、エラーハンドリング
   - メソッド: `callAPI()`, `streamAPI()`
   - 既存コードからの参照を新クライアントに変更

### フェーズ2: チャット機能の整理（3日間）

1. **chat.service.tsの再構築**
   - プロンプト定義を一元化
   - claude-api-clientの利用
   - ストリーミング処理の最適化

2. **chat-contexts.tsの新規作成**
   - 各モード別コンテキストテンプレートを分離
   - テンプレート生成ロジックの整理

### フェーズ3: 各サービスの段階的分離（5日間）

1. **fortune.service.ts**
   - デイリーフォーチュン生成機能の移行
   - 運勢スコア計算ロジックの整理

2. **lucky-items.service.ts**
   - ラッキーアイテム生成機能の移行
   - テンプレートとパース処理の整理

3. **harmony-compass.service.ts**
   - 調和のコンパス生成機能の移行
   - セクション解析処理の最適化

4. **member-card.service.ts**
   - チームメンバーカルテ生成機能の移行
   - カルテ構造の標準化

### フェーズ4: 不要コードの削除とテスト（2日間）

1. **claude-ai.tsのクリーンアップ**
   - 移行完了後の不要コードの削除
   - 後方互換性のためのラッパー関数の提供（必要に応じて）

2. **テスト整備**
   - 各サービスの単体テスト作成
   - エンドツーエンドテストの確認

## テスト戦略

- 各機能移行前後での出力一致テスト
- エラーケースの網羅的テスト
- パフォーマンス計測（特にストリーミング処理）

## リスクと対策

| リスク | 対策 |
|--------|------|
| 既存機能の中断 | 段階的移行、並行実行期間の設定 |
| プロンプト不整合 | テンプレート比較ツールの活用 |
| パフォーマンス低下 | 各ステップでのベンチマーク |
| 隠れた依存関係 | 依存関係図の事前作成 |

## 成功指標

1. コードの行数と複雑性の削減
2. 各機能の独立したテストカバレッジ
3. APIレスポンス時間の維持または改善
4. 新機能追加時の開発効率向上

## タイムライン

- 全体期間: 約2週間
- フェーズ1: 2日間
- フェーズ2: 3日間
- フェーズ3: 5日間
- フェーズ4: 2日間

このリファクタリングにより、システムの保守性と拡張性が大幅に向上し、今後の機能追加や改善がより効率的に行えるようになります。