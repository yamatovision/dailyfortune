# サジュエンジン国際対応リファクタリング計画

## 1. 現状分析

### 1.1 現在の実装状況

サジュエンジンの時柱計算における現在の実装状況を分析した結果、以下の点が明らかになりました：

1. **時差計算の基準**:
   - 日本標準時（東経135度）を基準としている
   - 経度1度あたり4分の時差を計算する方式を採用
   - 一部地域（東京エリア：+18分、ソウルエリア：-32分、北京エリア：-33分）は特別な調整値を持つ
   - その他の地域は単純な経度計算

2. **サマータイム処理**:
   - `useDST`オプションがあるが実際の判定ロジックが実装されていない
   - 日本のサマータイム期間（1948-1951年）の判定と処理が未実装

3. **時間調整プロセス**:
   - `DateTimeProcessor.ts`が時差計算と調整処理の中核
   - 分レベルの四捨五入は実装されているが、秒レベルの処理は不足
   - 複雑な日時のオーバーフロー処理が実装済み

4. **時柱計算ロジック**:
   - 出生時間と干支の対応は正確に実装されている
   - 「出生時間・干支対応表」に基づく日干と時間帯ごとの干支マッピングが実装済み

### 1.2 課題とリスク

1. **国際対応の限界**:
   - 経度ベースの計算では政治的タイムゾーンを正確に反映できない
   - 国や地域によるタイムゾーン規則の複雑さに対応できていない
   - 世界各国のサマータイム（夏時間/冬時間）に対応していない

2. **正確性の問題**:
   - 八季節文書に記載された秒単位の計算精度が実装されていない
   - 特定地域のみ特殊対応になっており、他地域では精度が落ちる

3. **拡張性の課題**:
   - 新しい国や地域を追加する際のスケーラビリティが低い
   - 歴史的なタイムゾーン変更への対応が困難

## 2. リファクタリング目標

### 2.1 主要目標

1. **世界各国の出生地対応**:
   - あらゆる国・地域の出生地に対応
   - 政治的タイムゾーンとサマータイム規則を正確に反映
   - 歴史的なタイムゾーン変更にも対応

2. **精度向上**:
   - 秒単位の精度での時差計算
   - 正確なサマータイム判定と調整

3. **拡張性の向上**:
   - 新しい地域の追加を容易にする設計
   - 標準ライブラリを活用した持続可能な実装

### 2.2 技術的要件

1. **タイムゾーンデータベース**:
   - IANA/Olsonタイムゾーンデータベースの活用
   - 歴史的なタイムゾーン変更情報の取り込み

2. **時差計算の2段階アプローチ**:
   - 標準的なタイムゾーン計算
   - 四柱推命特有の地方時調整（経度ベース）

3. **ユーザー体験向上**:
   - 出生地入力の改善（都市名、国名、タイムゾーン識別子など複数の入力方法）
   - 適用された調整についての透明性

## 3. 実装計画と進捗状況

### 3.1 フェーズ1: タイムゾーンモジュール実装（完了）

1. **✅ 依存ライブラリの導入**:
   ```bash
   npm install date-fns-tz luxon
   ```

2. **✅ タイムゾーンユーティリティクラスの作成**:
   - `TimeZoneUtils.ts` を実装
   - タイムゾーン識別子の取得
   - タイムゾーンオフセットの計算
   - サマータイム判定（現代および歴史的日本のサマータイム）
   - 経度ベースの時差計算

3. **✅ 秒単位調整の実装**:
   - `SecondAdjuster.ts` を実装
   - 八季節文書に準拠した秒の四捨五入処理
   - 秒単位での時間調整機能

4. **✅ タイムゾーンデータベースの統合**:
   - `TimeZoneDatabase.ts` を実装
   - 世界主要都市のデータベース構築
   - 都市検索機能（完全一致・部分一致・代替名）
   - 座標からの最寄り都市検索

5. **✅ テスト**:
   - 各モジュールの単体テストを実装
   - すべてのテストが通過

### 3.2 フェーズ2: DateTimeProcessor リファクタリング（完了）

1. **✅ DateTimeProcessor の拡張**:
   - 国際対応版 `DateTimeProcessor` を実装
   - タイムゾーンデータベースとの連携
   - 政治的タイムゾーンと経度ベースの二段階調整
   - 秒単位の精度を確保

2. **✅ ProcessedDateTime インターフェースの拡張**:
   - タイムゾーン情報と調整詳細を追加
   - 既存のインターフェースとの互換性を維持

3. **✅ テスト**:
   - DateTimeProcessor のテストを実装
   - 世界各地の都市での時間調整をテスト
   - サマータイムと秒単位の調整をテスト
   - すべてのテストが通過

### 3.3 フェーズ3: SajuEngine の拡張（完了）

1. **✅ SajuEngine の拡張**:
   - `SajuEngine` クラスに国際対応機能を統合
   - `SajuResult` インターフェースの拡張（タイムゾーン情報とロケーション情報を追加）
   - 拡張されたロケーション情報の処理

2. **✅ 出生地情報処理の強化**:
   - 都市名・座標・タイムゾーン識別子など複数の入力方法をサポート
   - 最寄りの都市情報の自動検索と適用
   - ExtendedLocation インターフェースのサポート

3. **✅ バックエンド統合テスト**:
   - 世界各地の都市での四柱推命計算結果の検証
   - 歴史的なサマータイム期間中の計算
   - サンプルアプリケーション（international-timezone.ts）の作成

### 3.4 フェーズ4: APIエンドポイントの実装とテスト（完了）

1. **✅ APIエンドポイントの実装**:
   - `GET /api/v1/day-pillars/timezone-info`：タイムゾーン情報を取得
   - `GET /api/v1/day-pillars/available-cities`：利用可能な都市リストを取得
   - テスト用ダミー実装の作成

2. **✅ テストスクリプトの作成と実行**:
   - `test-international-timezone.js`スクリプトの実装
   - 都市名、座標、拡張ロケーション情報による取得テスト
   - 利用可能な都市リスト取得テスト

3. **✅ TypeScript型エラーの解決**:
   - ExtendedLocation型の処理
   - timezoneInfo.adjustmentDetailsのnull安全対応
   - SajuOptionsとの型互換性問題を解決
   - FourPillarsのoriginalStem属性対応
   
4. **✅ テスト検証**:
   - 各APIエンドポイントが正常にレスポンスを返すことを確認
   - 主要都市（Tokyo, New York, London, Paris, Sydney）の情報が正しいことを確認
   - 座標指定のテストが正しく動作することを確認

### 3.5 フェーズ5: フロントエンド実装（完了）

1. **✅ UI コンポーネントの実装**:
   - `TimezoneSelector.tsx`: タイムゾーン選択コンポーネント
   - `InternationalLocationForm.tsx`: 拡張ロケーション情報入力フォーム
   - 調整情報表示コンポーネント

2. **✅ フロントエンドサービスの拡張**:
   - `day-pillar.service.ts`: タイムゾーン情報取得機能の追加
   - `saju-profile.service.ts`: 国際対応プロフィール情報の処理
   - `SajuProfileForm.tsx`: 国際対応モード切り替え機能の追加

## 4. 実装の課題と解決策

### 4.1 モジュール分離の課題

1. **問題点**:
   - sajuengine_packageとserverの依存関係における循環参照問題
   - 型定義ファイルの二重管理による一貫性の確保が難しい
   - サーバービルド時のTypeScriptエラー

2. **解決策**:
   - 一時的なダミー実装を使用して型エラーを回避
   - ハードコードされたタイムゾーンデータを使用したテスト用実装
   - 今後はnpmパッケージとして公開し、依存関係を明確化する

### 4.2 APIエンドポイントの課題

1. **問題点**:
   - MongoDBへの接続が必要なフルスタックサーバーでのテスト困難
   - 本番環境と開発環境での一貫性確保

2. **解決策**:
   - 軽量なテスト用サーバー（timezone-test-server.js）の実装
   - モックデータを使用した動作検証
   - 将来的にはAPI統合テストの拡充が必要

### 4.3 残課題

1. **技術的課題**:
   - フロントエンドとの完全な統合
   - 既存のユーザープロフィールデータへの国際対応情報の追加
   - パフォーマンス最適化（キャッシュ実装など）

2. **ドキュメント課題**:
   - API仕様書の更新
   - 国際対応機能の使用方法ガイド作成
   - エッジケース対応の説明資料作成

## 5. マイグレーション戦略

### 5.1 既存データの互換性

1. **データ構造への影響**:
   - 既存の四柱推命プロフィールデータは引き続き有効
   - 新たなタイムゾーン情報は追加的なデータとして扱い、既存機能は影響なし

2. **データベース更新**: ✅ 完了
   - `User`モデルに新たなフィールドを追加
   ```javascript
   // Server/src/models/User.ts の一部
   export interface IUser {
     // 既存フィールド
     birthDate?: Date;
     birthTime?: string;
     birthPlace?: string;
     gender?: Gender;
     birthplaceCoordinates?: {
       longitude: number;
       latitude: number;
     };
     localTimeOffset?: number;
     
     // 国際対応拡張情報（すべてオプショナル）
     timeZone?: string;                // タイムゾーン識別子（例：'Asia/Tokyo'）
     extendedLocation?: {              // 拡張されたロケーション情報
       name?: string;                  // 都市名
       country?: string;               // 国名
       coordinates: {                  // 座標（必須）
         longitude: number;
         latitude: number;
       };
       timeZone?: string;              // タイムゾーン識別子
     };
   }
   ```

### 5.2 段階的デプロイ

1. **✅ フェーズ1: ライブラリとコアロジックの更新** (完了)
   - 新しいライブラリを追加
   - TimeZoneUtils、SecondAdjuster の実装
   - 単体テストの実行

2. **✅ フェーズ2: DateTimeProcessor の更新** (完了)
   - 既存の実装を保持しながら拡張機能を追加
   - 後方互換性の検証

3. **✅ フェーズ3: SajuEngine の更新** (完了)
   - 既存の実装と並行して新機能を追加
   - 広範囲のテスト
   - サンプルアプリケーションの作成

4. **✅ フェーズ4: APIエンドポイントの実装** (完了)
   - タイムゾーン情報取得エンドポイントの実装
   - 利用可能な都市リスト取得エンドポイントの実装
   - 統合テストの実施

5. **✅ フェーズ5: クライアント側の更新** (完了)
   - 国際タイムゾーン対応モードの追加
   - 拡張ロケーション情報の入力UI実装
   - ユーザープロフィール編集フォームの強化

6. **📋 フェーズ6: データマイグレーション** (今後の予定)
   - 既存のプロフィールデータにタイムゾーン情報を推測・追加（オプション）
   - 新しいプロフィール作成時に拡張情報を保存

## 6. 引き継ぎ事項

### 6.1 完了項目

1. **モジュール実装**:
   - 国際タイムゾーン対応の基盤モジュールはすべて実装完了
   - SajuEngineの国際対応版は完成し、テスト済み
   - APIエンドポイントのテスト用実装が完了

2. **テスト状況**:
   - 単体テスト：完了（TimeZoneUtils, SecondAdjuster, TimeZoneDatabase, DateTimeProcessor）
   - 統合テスト：完了（SajuEngine国際対応版）
   - APIテスト：完了（test-international-timezone.jsによる検証）

3. **ドキュメント**:
   - リファクタリング計画書（本文書）の更新
   - 干合・支合処理ドキュメント（docs/saju_gan_shi_combination_rules.md）の更新

### 6.2 未完了項目

1. **サーバーコード修正**:
   - サーバー側での実際のタイムゾーンモジュール統合
   - 実環境でのタイムゾーン情報取得機能のデプロイ
   - パフォーマンス最適化

2. **~~フロントエンド実装~~**: ✅ 完了
   - ~~国際タイムゾーン対応のUI実装~~
   - ~~都市検索機能の実装~~
   - ~~ユーザー体験の向上~~

3. **データマイグレーション**:
   - 既存ユーザーのプロフィールデータの拡張
   - 新規ユーザー向けのプロフィール作成フローの強化

### 6.3 注意事項と推奨アクション

1. **モジュール依存関係**:
   - sajuengine_packageとserver間の依存関係を整理することを推奨
   - 理想的にはnpmパッケージとして公開し、明確なAPIを提供

2. **型定義の一元管理**:
   - ExtendedLocation, TimezoneAdjustmentInfoなどの型定義の一元管理
   - sajuengine_package/src/types.tsを参照することを推奨

3. **パフォーマンス考慮事項**:
   - タイムゾーン処理は比較的重い処理のため、キャッシュ戦略を検討
   - 頻繁に変更されない情報（都市リストなど）はクライアント側でキャッシュ

4. **テストカバレッジ**:
   - エッジケースのテスト拡充を推奨
   - 特に国際日付変更線付近やサマータイム切替時のテストが重要

## 7. 今後の展望

1. **機能強化**:
   - 世界各地のより詳細な都市データベースの拡充
   - 歴史的なタイムゾーン変更の更なる精緻化
   - 座標からの自動都市検出機能の精度向上

2. **ユーザー体験**:
   - マップベースの出生地選択インターフェース
   - タイムゾーン調整の可視化ツール
   - 複数の出生地バージョンの比較機能

3. **技術的発展**:
   - IANAタイムゾーンデータベースの定期的な更新メカニズム
   - 四柱推命計算の国際標準化への取り組み
   - sajuengine_packageを独立したnpmパッケージとして整理
   - 明確なAPIと型定義を提供するパッケージ化

## 8. 参考資料

- [IANA/Olsonタイムゾーンデータベース](https://www.iana.org/time-zones)
- [date-fns-tzライブラリ](https://github.com/marnusw/date-fns-tz)
- [Luxonライブラリ](https://moment.github.io/luxon/)
- [八季節文書: 時差修正と日本サマータイム期間](八季節_20250411_0603_i4_20250411_0603_0fd598.txt)
- [出生時間・干支対応表](IMG_4003_20250411_0627_2982d7.jpg)
- [テスト用シンプルサーバー実装](/server/scripts/timezone-test-server.js)
- [国際タイムゾーンテストスクリプト](/server/scripts/test-international-timezone.js)
- [国際タイムゾーン対応機能ドキュメント](/docs/international-timezone.md)

実装の詳細は状況に応じて調整し、最新のライブラリやベストプラクティスを取り入れながら進めていきます。

---

## 更新履歴

### 2025/4/11

- TypeScript型エラーの修正完了（SajuEngine, DateTimeProcessor, 型定義関連）
- テスト用サーバー実装によるAPIエンドポイントの検証完了
- 引き継ぎ事項と残課題の詳細化
- リファクタリング計画書を更新し、進捗状況と次のステップを明確化

### 2025/4/12

- フロントエンド実装（フェーズ5）の完了
- 新規コンポーネント（TimezoneSelector, InternationalLocationForm）の追加
- SajuProfileFormに国際対応モードの追加
- ドキュメントの更新と整備